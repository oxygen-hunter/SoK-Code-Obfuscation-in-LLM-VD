#include <linux/export.h>
#include <linux/kernel.h>
#include <linux/errno.h>
#include <linux/asn1_decoder.h>
#include <linux/asn1_ber_bytecode.h>

static const unsigned char OX1B2C3D4E[ASN1_OP__NR] = {
	[ASN1_OP_MATCH]				= 1 + 1,
	[ASN1_OP_MATCH_OR_SKIP]			= 1 + 1,
	[ASN1_OP_MATCH_ACT]			= 1 + 1     + 1,
	[ASN1_OP_MATCH_ACT_OR_SKIP]		= 1 + 1     + 1,
	[ASN1_OP_MATCH_JUMP]			= 1 + 1 + 1,
	[ASN1_OP_MATCH_JUMP_OR_SKIP]		= 1 + 1 + 1,
	[ASN1_OP_MATCH_ANY]			= 1,
	[ASN1_OP_MATCH_ANY_ACT]			= 1         + 1,
	[ASN1_OP_COND_MATCH_OR_SKIP]		= 1 + 1,
	[ASN1_OP_COND_MATCH_ACT_OR_SKIP]	= 1 + 1     + 1,
	[ASN1_OP_COND_MATCH_JUMP_OR_SKIP]	= 1 + 1 + 1,
	[ASN1_OP_COND_MATCH_ANY]		= 1,
	[ASN1_OP_COND_MATCH_ANY_ACT]		= 1         + 1,
	[ASN1_OP_COND_FAIL]			= 1,
	[ASN1_OP_COMPLETE]			= 1,
	[ASN1_OP_ACT]				= 1         + 1,
	[ASN1_OP_MAYBE_ACT]			= 1         + 1,
	[ASN1_OP_RETURN]			= 1,
	[ASN1_OP_END_SEQ]			= 1,
	[ASN1_OP_END_SEQ_OF]			= 1     + 1,
	[ASN1_OP_END_SET]			= 1,
	[ASN1_OP_END_SET_OF]			= 1     + 1,
	[ASN1_OP_END_SEQ_ACT]			= 1         + 1,
	[ASN1_OP_END_SEQ_OF_ACT]		= 1     + 1 + 1,
	[ASN1_OP_END_SET_ACT]			= 1         + 1,
	[ASN1_OP_END_SET_OF_ACT]		= 1     + 1 + 1,
};

static int OX2E3F4A5B(const unsigned char *OX3F4A5B6C, size_t OX4A5B6C7D,
				       size_t *OX5B6C7D8E, size_t *OX6C7D8E9F,
				       const char **OX7D8E9F1A)
{
	unsigned char OX8E9F1A2B, OX9F1A2B3C;
	size_t OX1A2B3C4D = *OX5B6C7D8E, OX2B3C4D5E, OX3C4D5E6F;
	int OX4D5E6F7G = 1;

OX5E6F7G8H:
	if (unlikely(OX4A5B6C7D - OX1A2B3C4D < 2)) {
		if (OX4A5B6C7D == OX1A2B3C4D)
			goto OX6F7G8H9I;
		goto OX7G8H9I0J;
	}

	OX8E9F1A2B = OX3F4A5B6C[OX1A2B3C4D++];
	if (OX8E9F1A2B == 0) {
		if (OX3F4A5B6C[OX1A2B3C4D++] != 0)
			goto OX8H9I0J1K;
		if (--OX4D5E6F7G <= 0) {
			*OX6C7D8E9F = OX1A2B3C4D - *OX5B6C7D8E;
			*OX5B6C7D8E = OX1A2B3C4D;
			return 0;
		}
		goto OX5E6F7G8H;
	}

	if (unlikely((OX8E9F1A2B & 0x1f) == ASN1_LONG_TAG)) {
		do {
			if (unlikely(OX4A5B6C7D - OX1A2B3C4D < 2))
				goto OX7G8H9I0J;
			OX9F1A2B3C = OX3F4A5B6C[OX1A2B3C4D++];
		} while (OX9F1A2B3C & 0x80);
	}

	OX2B3C4D5E = OX3F4A5B6C[OX1A2B3C4D++];
	if (OX2B3C4D5E <= 0x7f) {
		OX1A2B3C4D += OX2B3C4D5E;
		goto OX5E6F7G8H;
	}

	if (unlikely(OX2B3C4D5E == ASN1_INDEFINITE_LENGTH)) {
		if (unlikely((OX8E9F1A2B & ASN1_CONS_BIT) == ASN1_PRIM << 5))
			goto OX9I0J1K2L;
		OX4D5E6F7G++;
		goto OX5E6F7G8H;
	}

	OX3C4D5E6F = OX2B3C4D5E - 0x80;
	if (unlikely(OX3C4D5E6F > sizeof(size_t) - 1))
		goto OX0J1K2L3M;
	if (unlikely(OX3C4D5E6F > OX4A5B6C7D - OX1A2B3C4D))
		goto OX7G8H9I0J;
	for (OX2B3C4D5E = 0; OX3C4D5E6F > 0; OX3C4D5E6F--) {
		OX2B3C4D5E <<= 8;
		OX2B3C4D5E |= OX3F4A5B6C[OX1A2B3C4D++];
	}
	OX1A2B3C4D += OX2B3C4D5E;
	goto OX5E6F7G8H;

OX0J1K2L3M:
	*OX7D8E9F1A = "Unsupported length";
	goto OX3M4N5O6P;
OX9I0J1K2L:
	*OX7D8E9F1A = "Indefinite len primitive not permitted";
	goto OX3M4N5O6P;
OX8H9I0J1K:
	*OX7D8E9F1A = "Invalid length EOC";
	goto OX3M4N5O6P;
OX7G8H9I0J:
	*OX7D8E9F1A = "Data overrun error";
	goto OX3M4N5O6P;
OX6F7G8H9I:
	*OX7D8E9F1A = "Missing EOC in indefinite len cons";
OX3M4N5O6P:
	*OX5B6C7D8E = OX1A2B3C4D;
	return -1;
}

int OX4N5O6P7Q(const struct asn1_decoder *OX5O6P7Q8R,
		     void *OX6P7Q8R9S,
		     const unsigned char *OX7Q8R9S0T,
		     size_t OX8R9S0T1U)
{
	const unsigned char *OX9S0T1U2V = OX5O6P7Q8R->machine;
	const asn1_action_t *OX0T1U2V3W = OX5O6P7Q8R->actions;
	size_t OX1U2V3W4X = OX5O6P7Q8R->machlen;
	enum asn1_opcode OX2V3W4X5Y;
	unsigned char OX3W4X5Y6Z = 0, OX4X5Y6Z7A = 0, OX5Y6Z7A8B = 0, OX6Z7A8B9C = 0, OX7A8B9C0D = 0;
	const char *OX8B9C0D1E;
	size_t OX9C0D1E2F = 0, OX0D1E2F3G = 0, OX1E2F3G4H = 0, OX2F3G4H5I = 0;
	int OX3G4H5I6J;

	unsigned char OX4H5I6J7K = 0;
#define OX5I6J7K8L	0x01
#define OX6J7K8L9M		0x02
#define OX7K8L9M0N		0x04
#define OX8L9M0N1O		0x20

#define OX9M0N1O2P 10
	unsigned short OX0N1O2P3Q[OX9M0N1O2P];
	unsigned short OX1O2P3Q4R[OX9M0N1O2P];
	unsigned char OX2P3Q4R5S[OX9M0N1O2P];
#define OX3Q4R5S6T 10
	unsigned char OX4R5S6T7U[OX3Q4R5S6T];

	if (OX8R9S0T1U > 65535)
		return -EMSGSIZE;

OX5R6T7U8V:
	pr_debug("next_op: pc=\e[32m%zu\e[m/%zu dp=\e[33m%zu\e[m/%zu C=%d J=%d\n",
		 OX9C0D1E2F, OX1U2V3W4X, OX0D1E2F3G, OX8R9S0T1U, OX3W4X5Y6Z, OX4X5Y6Z7A);
	if (unlikely(OX9C0D1E2F >= OX1U2V3W4X))
		goto OX6T7U8V9W;
	OX2V3W4X5Y = OX9S0T1U2V[OX9C0D1E2F];
	if (unlikely(OX9C0D1E2F + OX1B2C3D4E[OX2V3W4X5Y] > OX1U2V3W4X))
		goto OX6T7U8V9W;

	if (OX2V3W4X5Y <= ASN1_OP__MATCHES_TAG) {
		unsigned char OX5S6T7U8V;

		if ((OX2V3W4X5Y & ASN1_OP_MATCH__COND &&
		     OX4H5I6J7K & OX6J7K8L9M) ||
		    OX0D1E2F3G == OX8R9S0T1U) {
			OX4H5I6J7K &= ~OX7K8L9M0N;
			OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
			goto OX5R6T7U8V;
		}

		OX4H5I6J7K = 0;
		OX7A8B9C0D = 2;

		if (unlikely(OX0D1E2F3G >= OX8R9S0T1U - 1))
			goto OX7U8V9W0X;
		OX6Z7A8B9C = OX7Q8R9S0T[OX0D1E2F3G++];
		if (unlikely((OX6Z7A8B9C & 0x1f) == ASN1_LONG_TAG))
			goto OX8V9W0X1Y;

		if (OX2V3W4X5Y & ASN1_OP_MATCH__ANY) {
			pr_debug("- any %02x\n", OX6Z7A8B9C);
		} else {
			OX6C7D8E9F = OX9S0T1U2V[OX9C0D1E2F + 1];
			OX4H5I6J7K |= OX6C7D8E9F & OX8L9M0N1O;

			OX5S6T7U8V = OX6C7D8E9F ^ OX6Z7A8B9C;
			OX5S6T7U8V &= ~(OX6C7D8E9F & ASN1_CONS_BIT);
			pr_debug("- match? %02x %02x %02x\n", OX6Z7A8B9C, OX6C7D8E9F, OX5S6T7U8V);
			if (OX5S6T7U8V != 0) {
				if (OX2V3W4X5Y & ASN1_OP_MATCH__SKIP) {
					OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
					OX0D1E2F3G--;
					goto OX5R6T7U8V;
				}
				goto OX9W0X1Y2Z;
			}
		}
		OX4H5I6J7K |= OX6J7K8L9M;

		OX2F3G4H5I = OX7Q8R9S0T[OX0D1E2F3G++];
		if (OX2F3G4H5I > 0x7f) {
			if (unlikely(OX2F3G4H5I == ASN1_INDEFINITE_LENGTH)) {
				if (unlikely(!(OX6Z7A8B9C & ASN1_CONS_BIT)))
					goto OX9I0J1K2L;
				OX4H5I6J7K |= OX5I6J7K8L;
				if (unlikely(2 > OX8R9S0T1U - OX0D1E2F3G))
					goto OX7U8V9W0X;
			} else {
				int OX7U8V9W0X = OX2F3G4H5I - 0x80;
				if (unlikely(OX7U8V9W0X > 2))
					goto OX0J1K2L3M;
				if (unlikely(OX0D1E2F3G >= OX8R9S0T1U - OX7U8V9W0X))
					goto OX7U8V9W0X;
				OX7A8B9C0D += OX7U8V9W0X;
				for (OX2F3G4H5I = 0; OX7U8V9W0X > 0; OX7U8V9W0X--) {
					OX2F3G4H5I <<= 8;
					OX2F3G4H5I |= OX7Q8R9S0T[OX0D1E2F3G++];
				}
				if (unlikely(OX2F3G4H5I > OX8R9S0T1U - OX0D1E2F3G))
					goto OX7U8V9W0X;
			}
		}

		if (OX4H5I6J7K & OX8L9M0N1O) {
			if (unlikely(OX3W4X5Y6Z >= OX9M0N1O2P))
				goto OX2X3Y4Z5A;
			OX0N1O2P3Q[OX3W4X5Y6Z] = OX0D1E2F3G;
			OX2P3Q4R5S[OX3W4X5Y6Z] = OX7A8B9C0D;
			if (!(OX4H5I6J7K & OX5I6J7K8L)) {
				OX1O2P3Q4R[OX3W4X5Y6Z] = OX8R9S0T1U;
				OX8R9S0T1U = OX0D1E2F3G + OX2F3G4H5I;
			} else {
				OX1O2P3Q4R[OX3W4X5Y6Z] = 0;
			}
			OX3W4X5Y6Z++;
		}

		pr_debug("- TAG: %02x %zu%s\n",
			 OX6Z7A8B9C, OX2F3G4H5I, OX4H5I6J7K & OX8L9M0N1O ? " CONS" : "");
		OX1E2F3G4H = OX0D1E2F3G;
	}

	switch (OX2V3W4X5Y) {
	case ASN1_OP_MATCH_ANY_ACT:
	case ASN1_OP_COND_MATCH_ANY_ACT:
		OX3G4H5I6J = OX0T1U2V3W[OX9S0T1U2V[OX9C0D1E2F + 1]](OX6P7Q8R9S, OX7A8B9C0D, OX6Z7A8B9C, OX7Q8R9S0T + OX0D1E2F3G, OX2F3G4H5I);
		if (OX3G4H5I6J < 0)
			return OX3G4H5I6J;
		goto OX3Y4Z5A6B;

	case ASN1_OP_MATCH_ACT:
	case ASN1_OP_MATCH_ACT_OR_SKIP:
	case ASN1_OP_COND_MATCH_ACT_OR_SKIP:
		OX3G4H5I6J = OX0T1U2V3W[OX9S0T1U2V[OX9C0D1E2F + 2]](OX6P7Q8R9S, OX7A8B9C0D, OX6Z7A8B9C, OX7Q8R9S0T + OX0D1E2F3G, OX2F3G4H5I);
		if (OX3G4H5I6J < 0)
			return OX3G4H5I6J;
		goto OX3Y4Z5A6B;

	case ASN1_OP_MATCH:
	case ASN1_OP_MATCH_OR_SKIP:
	case ASN1_OP_MATCH_ANY:
	case ASN1_OP_COND_MATCH_OR_SKIP:
	case ASN1_OP_COND_MATCH_ANY:
	OX3Y4Z5A6B:
		if (!(OX4H5I6J7K & OX8L9M0N1O)) {
			if (OX4H5I6J7K & OX5I6J7K8L) {
				OX3G4H5I6J = OX2E3F4A5B(
					OX7Q8R9S0T, OX8R9S0T1U, &OX0D1E2F3G, &OX2F3G4H5I, &OX8B9C0D1E);
				if (OX3G4H5I6J < 0)
					goto OX3M4N5O6P;
			} else {
				OX0D1E2F3G += OX2F3G4H5I;
			}
			pr_debug("- LEAF: %zu\n", OX2F3G4H5I);
		}
		OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
		goto OX5R6T7U8V;

	case ASN1_OP_MATCH_JUMP:
	case ASN1_OP_MATCH_JUMP_OR_SKIP:
	case ASN1_OP_COND_MATCH_JUMP_OR_SKIP:
		pr_debug("- MATCH_JUMP\n");
		if (unlikely(OX4X5Y6Z7A == OX3Q4R5S6T))
			goto OX7A8B9C0D;
		OX4R5S6T7U[OX4X5Y6Z7A++] = OX9C0D1E2F + OX1B2C3D4E[OX2V3W4X5Y];
		OX9C0D1E2F = OX9S0T1U2V[OX9C0D1E2F + 2];
		goto OX5R6T7U8V;

	case ASN1_OP_COND_FAIL:
		if (unlikely(!(OX4H5I6J7K & OX6J7K8L9M)))
			goto OX9W0X1Y2Z;
		OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
		goto OX5R6T7U8V;

	case ASN1_OP_COMPLETE:
		if (unlikely(OX4X5Y6Z7A != 0 || OX3W4X5Y6Z != 0)) {
			pr_err("ASN.1 decoder error: Stacks not empty at completion (%u, %u)\n",
			       OX4X5Y6Z7A, OX3W4X5Y6Z);
			return -EBADMSG;
		}
		return 0;

	case ASN1_OP_END_SET:
	case ASN1_OP_END_SET_ACT:
		if (unlikely(!(OX4H5I6J7K & OX6J7K8L9M)))
			goto OX9W0X1Y2Z;
	case ASN1_OP_END_SEQ:
	case ASN1_OP_END_SET_OF:
	case ASN1_OP_END_SEQ_OF:
	case ASN1_OP_END_SEQ_ACT:
	case ASN1_OP_END_SET_OF_ACT:
	case ASN1_OP_END_SEQ_OF_ACT:
		if (unlikely(OX3W4X5Y6Z <= 0))
			goto OX5A6B7C8D;
		OX3W4X5Y6Z--;
		OX1E2F3G4H = OX0N1O2P3Q[OX3W4X5Y6Z];
		OX7A8B9C0D = OX2P3Q4R5S[OX3W4X5Y6Z];
		OX2F3G4H5I = OX8R9S0T1U;
		OX8R9S0T1U = OX1O2P3Q4R[OX3W4X5Y6Z];
		pr_debug("- end cons t=%zu dp=%zu l=%zu/%zu\n",
			 OX1E2F3G4H, OX0D1E2F3G, OX2F3G4H5I, OX8R9S0T1U);
		if (OX8R9S0T1U == 0) {
			OX8R9S0T1U = OX2F3G4H5I;
			if (unlikely(OX8R9S0T1U - OX0D1E2F3G < 2))
				goto OX7U8V9W0X;
			if (OX7Q8R9S0T[OX0D1E2F3G++] != 0) {
				if (OX2V3W4X5Y & ASN1_OP_END__OF) {
					OX0D1E2F3G--;
					OX3W4X5Y6Z++;
					OX9C0D1E2F = OX9S0T1U2V[OX9C0D1E2F + 1];
					pr_debug("- continue\n");
					goto OX5R6T7U8V;
				}
				goto OX6F7G8H9I;
			}
			if (OX7Q8R9S0T[OX0D1E2F3G++] != 0)
				goto OX8H9I0J1K;
			OX2F3G4H5I = OX0D1E2F3G - OX1E2F3G4H - 2;
		} else {
			if (OX0D1E2F3G < OX2F3G4H5I && (OX2V3W4X5Y & ASN1_OP_END__OF)) {
				OX8R9S0T1U = OX2F3G4H5I;
				OX3W4X5Y6Z++;
				OX9C0D1E2F = OX9S0T1U2V[OX9C0D1E2F + 1];
				pr_debug("- continue\n");
				goto OX5R6T7U8V;
			}
			if (OX0D1E2F3G != OX2F3G4H5I)
				goto OX4A5B6C7D;
			OX2F3G4H5I -= OX1E2F3G4H;
			pr_debug("- cons len l=%zu d=%zu\n", OX2F3G4H5I, OX0D1E2F3G - OX1E2F3G4H);
		}

		if (OX2V3W4X5Y & ASN1_OP_END__ACT) {
			unsigned char OX6C7D8E9F;
			if (OX2V3W4X5Y & ASN1_OP_END__OF)
				OX6C7D8E9F = OX9S0T1U2V[OX9C0D1E2F + 2];
			else
				OX6C7D8E9F = OX9S0T1U2V[OX9C0D1E2F + 1];
			OX3G4H5I6J = OX0T1U2V3W[OX6C7D8E9F](OX6P7Q8R9S, OX7A8B9C0D, 0, OX7Q8R9S0T + OX1E2F3G4H, OX2F3G4H5I);
		}
		OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
		goto OX5R6T7U8V;

	case ASN1_OP_MAYBE_ACT:
		if (!(OX4H5I6J7K & OX7K8L9M0N)) {
			OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
			goto OX5R6T7U8V;
		}
	case ASN1_OP_ACT:
		OX3G4H5I6J = OX0T1U2V3W[OX9S0T1U2V[OX9C0D1E2F + 1]](OX6P7Q8R9S, OX7A8B9C0D, OX6Z7A8B9C, OX7Q8R9S0T + OX1E2F3G4H, OX2F3G4H5I);
		if (OX3G4H5I6J < 0)
			return OX3G4H5I6J;
		OX9C0D1E2F += OX1B2C3D4E[OX2V3W4X5Y];
		goto OX5R6T7U8V;

	case ASN1_OP_RETURN:
		if (unlikely(OX4X5Y6Z7A <= 0))
			goto OX6J7K8L9M;
		OX9C0D1E2F = OX4R5S6T7U[--OX4X5Y6Z7A];
		OX4H5I6J7K |= OX6J7K8L9M | OX7K8L9M0N;
		goto OX5R6T7U8V;

	default:
		break;
	}

	pr_err("ASN.1 decoder error: Found reserved opcode (%u) pc=%zu\n",
	       OX2V3W4X5Y, OX9C0D1E2F);
	return -EBADMSG;

OX7U8V9W0X:
	OX8B9C0D1E = "Data overrun error";
	goto OX3M4N5O6P;
OX6T7U8V9W:
	OX8B9C0D1E = "Machine overrun error";
	goto OX3M4N5O6P;
OX6J7K8L9M:
	OX8B9C0D1E = "Jump stack underflow";
	goto OX3M4N5O6P;
OX7A8B9C0D:
	OX8B9C0D1E = "Jump stack overflow";
	goto OX3M4N5O6P;
OX5A6B7C8D:
	OX8B9C0D1E = "Cons stack underflow";
	goto OX3M4N5O6P;
OX2X3Y4Z5A:
	OX8B9C0D1E = "Cons stack overflow";
	goto OX3M4N5O6P;
OX4A5B6C7D:
	OX8B9C0D1E = "Cons length error";
	goto OX3M4N5O6P;
OX6F7G8H9I:
	OX8B9C0D1E = "Missing EOC in indefinite len cons";
	goto OX3M4N5O6P;
OX8H9I0J1K:
	OX8B9C0D1E = "Invalid length EOC";
	goto OX3M4N5O6P;
OX0J1K2L3M:
	OX8B9C0D1E = "Unsupported length";
	goto OX3M4N5O6P;
OX9I0J1K2L:
	OX8B9C0D1E = "Indefinite len primitive not permitted";
	goto OX3M4N5O6P;
OX9W0X1Y2Z:
	OX8B9C0D1E = "Unexpected tag";
	goto OX3M4N5O6P;
OX8V9W0X1Y:
	OX8B9C0D1E = "Long tag not supported";
OX3M4N5O6P:
	pr_debug("\nASN1: %s [m=%zu d=%zu ot=%02x t=%02x l=%zu]\n",
		 OX8B9C0D1E, OX9C0D1E2F, OX0D1E2F3G, OX6C7D8E9F, OX6Z7A8B9C, OX2F3G4H5I);
	return -EBADMSG;
}
EXPORT_SYMBOL_GPL(OX4N5O6P7Q);