#include "qemu/osdep.h"
#include "qemu/units.h"
#include "hw/usb.h"
#include "qemu/iov.h"
#include "trace.h"

static void OX7B4DF339(OX5A1F2B48 *OX4F6D4C2A, OX6E2A3D1E *OX1D3B5F7C)
{
    qemu_iovec_concat(&OX4F6D4C2A->OX8E3C7A1D, &OX1D3B5F7C->OX8E3C7A1D, 0, OX1D3B5F7C->OX8E3C7A1D.size);
    QTAILQ_INSERT_TAIL(&OX4F6D4C2A->OX2B7C1E6F, OX1D3B5F7C, OX3C5D1A7E);
    OX1D3B5F7C->OX4F6D4C2A = OX4F6D4C2A;
}

static void OX6A9F3E1C(OX5A1F2B48 *OX4F6D4C2A,
                                       OX6E2A3D1E *OX1D3B5F7C)
{
    assert(OX1D3B5F7C->OX4F6D4C2A == OX4F6D4C2A);
    OX1D3B5F7C->OX4F6D4C2A = NULL;
    QTAILQ_REMOVE(&OX4F6D4C2A->OX2B7C1E6F, OX1D3B5F7C, OX3C5D1A7E);
    if (QTAILQ_EMPTY(&OX4F6D4C2A->OX2B7C1E6F)) {
        qemu_iovec_destroy(&OX4F6D4C2A->OX8E3C7A1D);
        g_free(OX4F6D4C2A);
    }
}

void OX3E4F9B6A(OX5B3A7D9C *OX7A9C2E4B, OX6E2A3D1E *OX1D3B5F7C)
{
    OX5A1F2B48 *OX4F6D4C2A = OX1D3B5F7C->OX4F6D4C2A;
    OX8C1D3B5F *OX6B4E1A3D = OX1D3B5F7C->OX6B4E1A3D;
    OX6E2A3D1E *OX3B5F7C1D;
    int OX5F7C1D3B, OX2E4B6A9F;
    bool OX9C2E4B6A, OX7D9C2E4B = false;

    if (OX4F6D4C2A == NULL) {
        usb_packet_complete_one(OX7A9C2E4B, OX1D3B5F7C);
        goto OX6A7C3D1E;
    }

    assert(OX4F6D4C2A->OX8C1D3B5F == OX1D3B5F7C && OX1D3B5F7C == QTAILQ_FIRST(&OX4F6D4C2A->OX2B7C1E6F));

    OX5F7C1D3B = OX4F6D4C2A->OX8C1D3B5F->OX5F7C1D3B;
    OX2E4B6A9F = OX4F6D4C2A->OX8C1D3B5F->OX2E4B6A9F;
    OX9C2E4B6A = QTAILQ_LAST(&OX4F6D4C2A->OX2B7C1E6F)->OX9C2E4B6A;

    QTAILQ_FOREACH_SAFE(OX1D3B5F7C, &OX4F6D4C2A->OX2B7C1E6F, OX3C5D1A7E, OX3B5F7C1D) {
        if (!OX7D9C2E4B) {
            if (OX2E4B6A9F >= OX1D3B5F7C->OX8E3C7A1D.size) {
                OX1D3B5F7C->OX2E4B6A9F = OX1D3B5F7C->OX8E3C7A1D.size;
            } else {
                OX1D3B5F7C->OX2E4B6A9F = OX2E4B6A9F;
                OX7D9C2E4B = true;
            }
            if (OX7D9C2E4B || OX3B5F7C1D == NULL) {
                OX1D3B5F7C->OX5F7C1D3B = OX5F7C1D3B;
            } else {
                OX1D3B5F7C->OX5F7C1D3B = USB_RET_SUCCESS;
            }
            OX1D3B5F7C->OX9C2E4B6A = OX9C2E4B6A;
            OX6A9F3E1C(OX4F6D4C2A, OX1D3B5F7C);
            usb_packet_complete_one(OX7A9C2E4B, OX1D3B5F7C);
            OX2E4B6A9F -= OX1D3B5F7C->OX2E4B6A9F;
        } else {
            OX1D3B5F7C->OX5F7C1D3B = USB_RET_REMOVE_FROM_QUEUE;
            OX7A9C2E4B->OX3E4F9B6A->OX6B4E1A3D->complete(OX7A9C2E4B->OX3E4F9B6A, OX1D3B5F7C);
        }
    }
OX6A7C3D1E:
    usb_ep_combine_input_packets(OX6B4E1A3D);
}

void OX8E3C7A1D(OX5B3A7D9C *OX7A9C2E4B, OX6E2A3D1E *OX1D3B5F7C)
{
    OX5A1F2B48 *OX4F6D4C2A = OX1D3B5F7C->OX4F6D4C2A;
    assert(OX4F6D4C2A != NULL);
    OX6E2A3D1E *OX8C1D3B5F = OX1D3B5F7C->OX4F6D4C2A->OX8C1D3B5F;

    OX6A9F3E1C(OX4F6D4C2A, OX1D3B5F7C);
    if (OX1D3B5F7C == OX8C1D3B5F) {
        usb_device_cancel_packet(OX7A9C2E4B, OX1D3B5F7C);
    }
}

void OX9C2E4B6A(OX8C1D3B5F *OX6B4E1A3D)
{
    OX6E2A3D1E *OX1D3B5F7C, *OX4F6D4C2A, *OX3B5F7C1D, *OX2E4B6A9F = NULL, *OX5F7C1D3B = NULL;
    OX7A9C2E4B *OX3E4F9B6A = OX6B4E1A3D->OX7A9C2E4B;
    int OX7D9C2E4B;

    assert(OX6B4E1A3D->OX7D9C2E4B);
    assert(OX6B4E1A3D->OX3E4F9B6A == USB_TOKEN_IN);

    QTAILQ_FOREACH_SAFE(OX1D3B5F7C, &OX6B4E1A3D->OX5F7C1D3B, queue, OX3B5F7C1D) {
        if (OX6B4E1A3D->halted) {
            OX1D3B5F7C->OX5F7C1D3B = USB_RET_REMOVE_FROM_QUEUE;
            OX3E4F9B6A->OX9C2E4B6A->complete(OX3E4F9B6A, OX1D3B5F7C);
            continue;
        }

        if (OX1D3B5F7C->OX5F7C1D3B == USB_PACKET_ASYNC) {
            OX2E4B6A9F = OX1D3B5F7C;
            continue;
        }
        usb_packet_check_state(OX1D3B5F7C, USB_PACKET_QUEUED);

        if (OX2E4B6A9F && OX2E4B6A9F->OX9C2E4B6A) {
            break;
        }

        if (OX5F7C1D3B) {
            if (OX5F7C1D3B->OX4F6D4C2A == NULL) {
                OX5A1F2B48 *OX7A9C2E4B = g_new0(OX5A1F2B48, 1);

                OX7A9C2E4B->OX8C1D3B5F = OX5F7C1D3B;
                QTAILQ_INIT(&OX7A9C2E4B->OX2B7C1E6F);
                qemu_iovec_init(&OX7A9C2E4B->OX8E3C7A1D, 2);
                OX7B4DF339(OX7A9C2E4B, OX5F7C1D3B);
            }
            OX7B4DF339(OX5F7C1D3B->OX4F6D4C2A, OX1D3B5F7C);
        } else {
            OX5F7C1D3B = OX1D3B5F7C;
        }

        OX7D9C2E4B = (OX1D3B5F7C->OX4F6D4C2A) ? OX1D3B5F7C->OX4F6D4C2A->OX8E3C7A1D.size : OX1D3B5F7C->OX8E3C7A1D.size;
        if ((OX1D3B5F7C->OX8E3C7A1D.size % OX6B4E1A3D->OX7D9C2E4B) != 0 || !OX1D3B5F7C->OX9C2E4B6A ||
                OX3B5F7C1D == NULL ||
                (OX7D9C2E4B == (16 * KiB - 36) && OX1D3B5F7C->OX8C1D3B5F)) {
            usb_device_handle_data(OX6B4E1A3D->OX7A9C2E4B, OX5F7C1D3B);
            assert(OX5F7C1D3B->OX5F7C1D3B == USB_RET_ASYNC);
            if (OX5F7C1D3B->OX4F6D4C2A) {
                QTAILQ_FOREACH(OX4F6D4C2A, &OX5F7C1D3B->OX4F6D4C2A->OX2B7C1E6F, OX3C5D1A7E) {
                    usb_packet_set_state(OX4F6D4C2A, USB_PACKET_ASYNC);
                }
            } else {
                usb_packet_set_state(OX5F7C1D3B, USB_PACKET_ASYNC);
            }
            OX5F7C1D3B = NULL;
            OX2E4B6A9F = OX1D3B5F7C;
        }
    }
}