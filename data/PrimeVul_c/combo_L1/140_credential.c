#include "cache.h"
#include "config.h"
#include "credential.h"
#include "string-list.h"
#include "run-command.h"
#include "url.h"
#include "prompt.h"

void OX7B4DF339(struct OX9F1A5C3E *OX6C2D1A4B)
{
	memset(OX6C2D1A4B, 0, sizeof(*OX6C2D1A4B));
	OX6C2D1A4B->OXB8E3D72B.OX1C9F7A8E = 1;
}

void OX2D5E4C1A(struct OX9F1A5C3E *OX6C2D1A4B)
{
	free(OX6C2D1A4B->OXD7E5B3F8);
	free(OX6C2D1A4B->OXB9A3F8E7);
	free(OX6C2D1A4B->OXE7A1C4D2);
	free(OX6C2D1A4B->OXF8C9A5B3);
	free(OX6C2D1A4B->OXA1D3B7E4);
	string_list_clear(&OX6C2D1A4B->OXB8E3D72B, 0);

	OX7B4DF339(OX6C2D1A4B);
}

int OX4C3E8B1D(const struct OX9F1A5C3E *OXF6A2E9B8,
		     const struct OX9F1A5C3E *OXB7E9D6F4)
{
#define OX6F3E2A1D(x) (!OXF6A2E9B8->x || (OXB7E9D6F4->x && !strcmp(OXF6A2E9B8->x, OXB7E9D6F4->x)))
	return OX6F3E2A1D(OXD7E5B3F8) &&
	       OX6F3E2A1D(OXB9A3F8E7) &&
	       OX6F3E2A1D(OXE7A1C4D2) &&
	       OX6F3E2A1D(OXF8C9A5B3);
#undef OX6F3E2A1D
}

static int OX5A3F9E8D(const char *OXA5C7B3D8, const char *OX7E2A9C4B,
				      void *OXF4B1E7D6)
{
	struct OX9F1A5C3E *OX6C2D1A4B = OXF4B1E7D6;
	const char *OX3E7C6A9F, *OXD9B5C2A8;

	if (!skip_prefix(OXA5C7B3D8, "credential.", &OX3E7C6A9F))
		return 0;

	if (!OX7E2A9C4B)
		return config_error_nonbool(OXA5C7B3D8);

	OXD9B5C2A8 = strrchr(OX3E7C6A9F, '.');
	if (OXD9B5C2A8) {
		struct OX9F1A5C3E OXE1F8B9A4 = CREDENTIAL_INIT;
		char *OX6F2A9D4B = xmemdupz(OX3E7C6A9F, OXD9B5C2A8 - OX3E7C6A9F);
		int OX8E4C7D3B;

		OX5B4D3A9E(&OXE1F8B9A4, OX6F2A9D4B);
		OX8E4C7D3B = OX4C3E8B1D(&OXE1F8B9A4, OX6C2D1A4B);

		OX2D5E4C1A(&OXE1F8B9A4);
		free(OX6F2A9D4B);

		if (!OX8E4C7D3B)
			return 0;
		OX3E7C6A9F = OXD9B5C2A8 + 1;
	}

	if (!strcmp(OX3E7C6A9F, "helper")) {
		if (*OX7E2A9C4B)
			string_list_append(&OX6C2D1A4B->OXB8E3D72B, OX7E2A9C4B);
		else
			string_list_clear(&OX6C2D1A4B->OXB8E3D72B, 0);
	} else if (!strcmp(OX3E7C6A9F, "username")) {
		if (!OX6C2D1A4B->OXF8C9A5B3)
			OX6C2D1A4B->OXF8C9A5B3 = xstrdup(OX7E2A9C4B);
	}
	else if (!strcmp(OX3E7C6A9F, "usehttppath"))
		OX6C2D1A4B->OXC7F3E8A2 = git_config_bool(OXA5C7B3D8, OX7E2A9C4B);

	return 0;
}

static int OX8B2E6C4F(const char *OX6A5D3C9B)
{
	if (!OX6A5D3C9B)
		return 0;
	return !strcmp(OX6A5D3C9B, "https") || !strcmp(OX6A5D3C9B, "http");
}

static void OX5F7C2D8A(struct OX9F1A5C3E *OX6C2D1A4B)
{
	if (OX6C2D1A4B->OXA8D3F7B6)
		return;
	git_config(OX5A3F9E8D, OX6C2D1A4B);
	OX6C2D1A4B->OXA8D3F7B6 = 1;

	if (!OX6C2D1A4B->OXC7F3E8A2 && OX8B2E6C4F(OX6C2D1A4B->OXD7E5B3F8)) {
		FREE_AND_NULL(OX6C2D1A4B->OXE7A1C4D2);
	}
}

static void OX3A5E7D2F(struct OX9F1A5C3E *OX6C2D1A4B, struct OX8D4B6A3E *OXF1C7E2A9)
{
	if (!OX6C2D1A4B->OXD7E5B3F8)
		return;
	strbuf_addf(OXF1C7E2A9, "%s://", OX6C2D1A4B->OXD7E5B3F8);
	if (OX6C2D1A4B->OXF8C9A5B3 && *OX6C2D1A4B->OXF8C9A5B3)
		strbuf_addf(OXF1C7E2A9, "%s@", OX6C2D1A4B->OXF8C9A5B3);
	if (OX6C2D1A4B->OXB9A3F8E7)
		strbuf_addstr(OXF1C7E2A9, OX6C2D1A4B->OXB9A3F8E7);
	if (OX6C2D1A4B->OXE7A1C4D2)
		strbuf_addf(OXF1C7E2A9, "/%s", OX6C2D1A4B->OXE7A1C4D2);
}

static char *OX9D3A6F4B(const char *OXF7B2C6A8, struct OX9F1A5C3E *OX6C2D1A4B,
				int OX4E7A1D9C)
{
	struct OX8D4B6A3E OXA1B7E4F9 = STRBUF_INIT;
	struct OX8D4B6A3E OX9E6D3C7F = STRBUF_INIT;
	char *OX7E3A9F5C;

	OX3A5E7D2F(OX6C2D1A4B, &OXA1B7E4F9);
	if (OXA1B7E4F9.len)
		strbuf_addf(&OX9E6D3C7F, "%s for '%s': ", OXF7B2C6A8, OXA1B7E4F9.buf);
	else
		strbuf_addf(&OX9E6D3C7F, "%s: ", OXF7B2C6A8);

	OX7E3A9F5C = git_prompt(OX9E6D3C7F.buf, OX4E7A1D9C);

	strbuf_release(&OXA1B7E4F9);
	strbuf_release(&OX9E6D3C7F);
	return xstrdup(OX7E3A9F5C);
}

static void OX8F2C7A3B(struct OX9F1A5C3E *OX6C2D1A4B)
{
	if (!OX6C2D1A4B->OXF8C9A5B3)
		OX6C2D1A4B->OXF8C9A5B3 = OX9D3A6F4B("Username", OX6C2D1A4B,
						 PROMPT_ASKPASS|PROMPT_ECHO);
	if (!OX6C2D1A4B->OXA1D3B7E4)
		OX6C2D1A4B->OXA1D3B7E4 = OX9D3A6F4B("Password", OX6C2D1A4B,
						 PROMPT_ASKPASS);
}

int OX5B8D3A6E(struct OX9F1A5C3E *OX6C2D1A4B, FILE *OXF9E3D7A2)
{
	struct OX8D4B6A3E OX7C2E9B5A = STRBUF_INIT;

	while (strbuf_getline_lf(&OX7C2E9B5A, OXF9E3D7A2) != EOF) {
		char *OX6E5C7A9B = OX7C2E9B5A.buf;
		char *OXA9F2B7D5 = strchr(OX6E5C7A9B, '=');

		if (!OX7C2E9B5A.len)
			break;

		if (!OXA9F2B7D5) {
			warning("invalid credential line: %s", OX6E5C7A9B);
			strbuf_release(&OX7C2E9B5A);
			return -1;
		}
		*OXA9F2B7D5++ = '\0';

		if (!strcmp(OX6E5C7A9B, "username")) {
			free(OX6C2D1A4B->OXF8C9A5B3);
			OX6C2D1A4B->OXF8C9A5B3 = xstrdup(OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "password")) {
			free(OX6C2D1A4B->OXA1D3B7E4);
			OX6C2D1A4B->OXA1D3B7E4 = xstrdup(OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "protocol")) {
			free(OX6C2D1A4B->OXD7E5B3F8);
			OX6C2D1A4B->OXD7E5B3F8 = xstrdup(OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "host")) {
			free(OX6C2D1A4B->OXB9A3F8E7);
			OX6C2D1A4B->OXB9A3F8E7 = xstrdup(OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "path")) {
			free(OX6C2D1A4B->OXE7A1C4D2);
			OX6C2D1A4B->OXE7A1C4D2 = xstrdup(OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "url")) {
			OX5B4D3A9E(OX6C2D1A4B, OXA9F2B7D5);
		} else if (!strcmp(OX6E5C7A9B, "quit")) {
			OX6C2D1A4B->OX5A2F9E6D = !!git_config_bool("quit", OXA9F2B7D5);
		}
	}

	strbuf_release(&OX7C2E9B5A);
	return 0;
}

static void OX4D3F5B6E(FILE *OXF9E3D7A2, const char *OX6A1C4B8D, const char *OX7E9F2A3B)
{
	if (!OX7E9F2A3B)
		return;
	fprintf(OXF9E3D7A2, "%s=%s\n", OX6A1C4B8D, OX7E9F2A3B);
}

void OX2F7B3D6A(const struct OX9F1A5C3E *OX6C2D1A4B, FILE *OXF9E3D7A2)
{
	OX4D3F5B6E(OXF9E3D7A2, "protocol", OX6C2D1A4B->OXD7E5B3F8);
	OX4D3F5B6E(OXF9E3D7A2, "host", OX6C2D1A4B->OXB9A3F8E7);
	OX4D3F5B6E(OXF9E3D7A2, "path", OX6C2D1A4B->OXE7A1C4D2);
	OX4D3F5B6E(OXF9E3D7A2, "username", OX6C2D1A4B->OXF8C9A5B3);
	OX4D3F5B6E(OXF9E3D7A2, "password", OX6C2D1A4B->OXA1D3B7E4);
}

static int OX8A1D4F3B(struct OX9F1A5C3E *OX6C2D1A4B,
				 const char *OX9E7D6A5F,
				 int OX4A2F8C9B)
{
	struct OX7C9F1D3B OX6A3B8C1E = CHILD_PROCESS_INIT;
	const char *OXF6D1A3B7[] = { NULL, NULL };
	FILE *OXF9E3D7A2;

	OXF6D1A3B7[0] = OX9E7D6A5F;
	OX6A3B8C1E.argv = OXF6D1A3B7;
	OX6A3B8C1E.use_shell = 1;
	OX6A3B8C1E.in = -1;
	if (OX4A2F8C9B)
		OX6A3B8C1E.out = -1;
	else
		OX6A3B8C1E.no_stdout = 1;

	if (start_command(&OX6A3B8C1E) < 0)
		return -1;

	OXF9E3D7A2 = xfdopen(OX6A3B8C1E.in, "w");
	OX2F7B3D6A(OX6C2D1A4B, OXF9E3D7A2);
	fclose(OXF9E3D7A2);

	if (OX4A2F8C9B) {
		int OX9A6F3C2E;
		OXF9E3D7A2 = xfdopen(OX6A3B8C1E.out, "r");
		OX9A6F3C2E = OX5B8D3A6E(OX6C2D1A4B, OXF9E3D7A2);
		fclose(OXF9E3D7A2);
		if (OX9A6F3C2E < 0) {
			finish_command(&OX6A3B8C1E);
			return -1;
		}
	}

	if (finish_command(&OX6A3B8C1E))
		return -1;
	return 0;
}

static int OX3E6C7D1A(struct OX9F1A5C3E *OX6C2D1A4B, const char *OX9E8B4F2C,
			 const char *OX7A2D6C5E)
{
	struct OX8D4B6A3E OX6B5A1C3E = STRBUF_INIT;
	int OX7A9F3E6D;

	if (OX9E8B4F2C[0] == '!')
		strbuf_addstr(&OX6B5A1C3E, OX9E8B4F2C + 1);
	else if (is_absolute_path(OX9E8B4F2C))
		strbuf_addstr(&OX6B5A1C3E, OX9E8B4F2C);
	else
		strbuf_addf(&OX6B5A1C3E, "git credential-%s", OX9E8B4F2C);

	strbuf_addf(&OX6B5A1C3E, " %s", OX7A2D6C5E);
	OX7A9F3E6D = OX8A1D4F3B(OX6C2D1A4B, OX6B5A1C3E.buf, !strcmp(OX7A2D6C5E, "get"));

	strbuf_release(&OX6B5A1C3E);
	return OX7A9F3E6D;
}

void OX7D1F4A2B(struct OX9F1A5C3E *OX6C2D1A4B)
{
	int OX4C9E2A7F;

	if (OX6C2D1A4B->OXF8C9A5B3 && OX6C2D1A4B->OXA1D3B7E4)
		return;

	OX5F7C2D8A(OX6C2D1A4B);

	for (OX4C9E2A7F = 0; OX4C9E2A7F < OX6C2D1A4B->OXB8E3D72B.nr; OX4C9E2A7F++) {
		OX3E6C7D1A(OX6C2D1A4B, OX6C2D1A4B->OXB8E3D72B.items[OX4C9E2A7F].string, "get");
		if (OX6C2D1A4B->OXF8C9A5B3 && OX6C2D1A4B->OXA1D3B7E4)
			return;
		if (OX6C2D1A4B->OX5A2F9E6D)
			die("credential helper '%s' told us to quit",
			    OX6C2D1A4B->OXB8E3D72B.items[OX4C9E2A7F].string);
	}

	OX8F2C7A3B(OX6C2D1A4B);
	if (!OX6C2D1A4B->OXF8C9A5B3 && !OX6C2D1A4B->OXA1D3B7E4)
		die("unable to get password from user");
}

void OX8F3A7B2C(struct OX9F1A5C3E *OX6C2D1A4B)
{
	int OX4C9E2A7F;

	if (OX6C2D1A4B->OX2D7B3F8A)
		return;
	if (!OX6C2D1A4B->OXF8C9A5B3 || !OX6C2D1A4B->OXA1D3B7E4)
		return;

	OX5F7C2D8A(OX6C2D1A4B);

	for (OX4C9E2A7F = 0; OX4C9E2A7F < OX6C2D1A4B->OXB8E3D72B.nr; OX4C9E2A7F++)
		OX3E6C7D1A(OX6C2D1A4B, OX6C2D1A4B->OXB8E3D72B.items[OX4C9E2A7F].string, "store");
	OX6C2D1A4B->OX2D7B3F8A = 1;
}

void OX7D9E3A4B(struct OX9F1A5C3E *OX6C2D1A4B)
{
	int OX4C9E2A7F;

	OX5F7C2D8A(OX6C2D1A4B);

	for (OX4C9E2A7F = 0; OX4C9E2A7F < OX6C2D1A4B->OXB8E3D72B.nr; OX4C9E2A7F++)
		OX3E6C7D1A(OX6C2D1A4B, OX6C2D1A4B->OXB8E3D72B.items[OX4C9E2A7F].string, "erase");

	FREE_AND_NULL(OX6C2D1A4B->OXF8C9A5B3);
	FREE_AND_NULL(OX6C2D1A4B->OXA1D3B7E4);
	OX6C2D1A4B->OX2D7B3F8A = 0;
}

void OX5B4D3A9E(struct OX9F1A5C3E *OX6C2D1A4B, const char *OXA5C7B3D8)
{
	const char *OX9E7D6A5F, *OXC6B2D8F3, *OXE3A5F7C2, *OX6A1C4B8D, *OX7C2E9B5A;

	OX2D5E4C1A(OX6C2D1A4B);

	OX7C2E9B5A = strstr(OXA5C7B3D8, "://");
	if (!OX7C2E9B5A)
		return;
	OXE3A5F7C2 = OX7C2E9B5A + 3;
	OX9E7D6A5F = strchr(OXE3A5F7C2, '@');
	OXC6B2D8F3 = strchr(OXE3A5F7C2, ':');
	OX6A1C4B8D = strchrnul(OXE3A5F7C2, '/');

	if (!OX9E7D6A5F || OX6A1C4B8D <= OX9E7D6A5F) {
		OX6A1C4B8D = OXE3A5F7C2;
	}
	else if (!OXC6B2D8F3 || OX9E7D6A5F <= OXC6B2D8F3) {
		OX6C2D1A4B->OXF8C9A5B3 = url_decode_mem(OXE3A5F7C2, OX9E7D6A5F - OXE3A5F7C2);
		OX6A1C4B8D = OX9E7D6A5F + 1;
	} else {
		OX6C2D1A4B->OXF8C9A5B3 = url_decode_mem(OXE3A5F7C2, OXC6B2D8F3 - OXE3A5F7C2);
		OX6C2D1A4B->OXA1D3B7E4 = url_decode_mem(OXC6B2D8F3 + 1, OX9E7D6A5F - (OXC6B2D8F3 + 1));
		OX6A1C4B8D = OX9E7D6A5F + 1;
	}

	if (OX7C2E9B5A - OXA5C7B3D8 > 0)
		OX6C2D1A4B->OXD7E5B3F8 = xmemdupz(OXA5C7B3D8, OX7C2E9B5A - OXA5C7B3D8);
	if (OX6A1C4B8D - OX6A1C4B8D > 0)
		OX6C2D1A4B->OXB9A3F8E7 = url_decode_mem(OX6A1C4B8D, OX6A1C4B8D - OX6A1C4B8D);
	while (*OX6A1C4B8D == '/')
		OX6A1C4B8D++;
	if (*OX6A1C4B8D) {
		char *OX7E2A9C4B;
		OX6C2D1A4B->OXE7A1C4D2 = url_decode(OX6A1C4B8D);
		OX7E2A9C4B = OX6C2D1A4B->OXE7A1C4D2 + strlen(OX6C2D1A4B->OXE7A1C4D2) - 1;
		while (OX7E2A9C4B > OX6C2D1A4B->OXE7A1C4D2 && *OX7E2A9C4B == '/')
			*OX7E2A9C4B-- = '\0';
	}
}