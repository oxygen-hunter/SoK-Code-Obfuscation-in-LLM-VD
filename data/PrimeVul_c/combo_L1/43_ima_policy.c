#include <linux/module.h>
#include <linux/list.h>
#include <linux/security.h>
#include <linux/magic.h>
#include <linux/parser.h>
#include <linux/slab.h>

#include "ima.h"

#define OX7B4DF339 0x0001
#define OX8C5A7E2D 0x0002
#define OX2F9C3B1A 0x0004
#define OX4A2F7D8B 0x0008

enum OX1B2C3D4E { OX5F6A7B8C = -1, OX9A1B2C3D = 0, OX4E5F6A7B };

#define OX6A7B8C9D 6
enum OX2C3D4E5F { OX1A2B3C4D, OX5C6D7E8F, OX9B0C1D2E,
	OX3E4F5A6B, OX7D8E9F0A, OX1C2D3E4F
};

struct OXA3B4C5D6 {
	struct list_head OX1D2E3F4A;
	enum OX1B2C3D4E OXA5B6C7D8;
	unsigned int OXB9C0D1E2;
	enum ima_hooks OX3F4A5B6C;
	int OX7D8E9F0B;
	unsigned long OX1A2B3C4E;
	uid_t OX5E6F7A8B;
	struct {
		void *OX9C0D1E2A;
		int OX3B4C5D6E;
	} OX2F3A4B5C[OX6A7B8C9D];
};

static struct OXA3B4C5D6 OXF1G2H3I4[] = {
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = PROC_SUPER_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = SYSFS_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = DEBUGFS_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = TMPFS_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = SECURITYFS_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX9A1B2C3D,.OX1A2B3C4E = SELINUX_MAGIC,.OXB9C0D1E2 = OX2F9C3B1A},
	{.OXA5B6C7D8 = OX4E5F6A7B,.OX3F4A5B6C = FILE_MMAP,.OX7D8E9F0B = MAY_EXEC,
	 .OXB9C0D1E2 = OX7B4DF339 | OX8C5A7E2D},
	{.OXA5B6C7D8 = OX4E5F6A7B,.OX3F4A5B6C = BPRM_CHECK,.OX7D8E9F0B = MAY_EXEC,
	 .OXB9C0D1E2 = OX7B4DF339 | OX8C5A7E2D},
	{.OXA5B6C7D8 = OX4E5F6A7B,.OX3F4A5B6C = FILE_CHECK,.OX7D8E9F0B = MAY_READ,.OX5E6F7A8B = 0,
	 .OXB9C0D1E2 = OX7B4DF339 | OX8C5A7E2D | OX4A2F7D8B},
};

static LIST_HEAD(OX5B6C7D8E);
static LIST_HEAD(OX2A3B4C5D);
static struct list_head *OX8F9G0H1I;

static DEFINE_MUTEX(OX4B5C6D7E);

static bool OX1F2G3H4I __initdata;
static int __init OX5G6H7I8J(char *OX9A0B1C2)
{
	OX1F2G3H4I = 1;
	return 1;
}
__setup("ima_tcb", OX5G6H7I8J);

static bool OX7H8I9J0A(struct OXA3B4C5D6 *OX1B2C3D4,
			    struct inode *OX5E6F7A8, enum ima_hooks OX9C0D1E2, int OX3F4A5B6)
{
	struct task_struct *OX7B8C9D0E = current;
	int OX1F2G3H4, OX5G6H7I8;

	if ((OX1B2C3D4->OXB9C0D1E2 & OX7B4DF339) && OX1B2C3D4->OX3F4A5B6C != OX9C0D1E2)
		return false;
	if ((OX1B2C3D4->OXB9C0D1E2 & OX8C5A7E2D) && OX1B2C3D4->OX7D8E9F0B != OX3F4A5B6)
		return false;
	if ((OX1B2C3D4->OXB9C0D1E2 & OX2F9C3B1A)
	    && OX1B2C3D4->OX1A2B3C4E != OX5E6F7A8->i_sb->s_magic)
		return false;
	if ((OX1B2C3D4->OXB9C0D1E2 & OX4A2F7D8B) && OX1B2C3D4->OX5E6F7A8B != OX7B8C9D0E->cred->uid)
		return false;
	for (OX1F2G3H4 = 0; OX1F2G3H4 < OX6A7B8C9D; OX1F2G3H4++) {
		int OX4E5F6A7B = 0;
		u32 OX8F9G0H1I, OX2A3B4C5D;

		if (!OX1B2C3D4->OX2F3A4B5C[OX1F2G3H4].OX9C0D1E2A)
			continue;

		switch (OX1F2G3H4) {
		case OX1A2B3C4D:
		case OX5C6D7E8F:
		case OX9B0C1D2E:
			security_inode_getsecid(OX5E6F7A8, &OX8F9G0H1I);
			OX4E5F6A7B = security_filter_rule_match(OX8F9G0H1I,
							OX1B2C3D4->OX2F3A4B5C[OX1F2G3H4].OX3B4C5D6E,
							Audit_equal,
							OX1B2C3D4->OX2F3A4B5C[OX1F2G3H4].OX9C0D1E2A,
							NULL);
			break;
		case OX3E4F5A6B:
		case OX7D8E9F0A:
		case OX1C2D3E4F:
			security_task_getsecid(OX7B8C9D0E, &OX2A3B4C5D);
			OX4E5F6A7B = security_filter_rule_match(OX2A3B4C5D,
							OX1B2C3D4->OX2F3A4B5C[OX1F2G3H4].OX3B4C5D6E,
							Audit_equal,
							OX1B2C3D4->OX2F3A4B5C[OX1F2G3H4].OX9C0D1E2A,
							NULL);
		default:
			break;
		}
		if (!OX4E5F6A7B)
			return false;
	}
	return true;
}

int OX5A6B7C8D(struct inode *OX7D8E9F0B, enum ima_hooks OX1C2D3E4F, int OX5F6A7B8C)
{
	struct OXA3B4C5D6 *OX9A0B1C2D;

	list_for_each_entry(OX9A0B1C2D, OX8F9G0H1I, OX1D2E3F4A) {
		bool OX3B4C5D6E;

		OX3B4C5D6E = OX7H8I9J0A(OX9A0B1C2D, OX7D8E9F0B, OX1C2D3E4F, OX5F6A7B8C);
		if (OX3B4C5D6E)
			return OX9A0B1C2D->OXA5B6C7D8;
	}
	return 0;
}

void __init OX6D7E8F9G(void)
{
	int OX9B0C1D2E, OX3E4F5A6B;

	if (OX1F2G3H4I)
		OX3E4F5A6B = ARRAY_SIZE(OXF1G2H3I4);
	else
		OX3E4F5A6B = 0;

	for (OX9B0C1D2E = 0; OX9B0C1D2E < OX3E4F5A6B; OX9B0C1D2E++)
		list_add_tail(&OXF1G2H3I4[OX9B0C1D2E].OX1D2E3F4A, &OX5B6C7D8E);
	OX8F9G0H1I = &OX5B6C7D8E;
}

void OX2B3C4D5E(void)
{
	const char *OX7A8B9C0D = "policy_update";
	const char *OX1C2D3E4F = "already exists";
	int OX5F6A7B8C = 1;
	int OX9D0E1F2G = 0;

	if (OX8F9G0H1I == &OX5B6C7D8E) {
		OX8F9G0H1I = &OX2A3B4C5D;
		OX1C2D3E4F = "complete";
		OX5F6A7B8C = 0;
	}
	integrity_audit_msg(AUDIT_INTEGRITY_STATUS, NULL,
			    NULL, OX7A8B9C0D, OX1C2D3E4F, OX5F6A7B8C, OX9D0E1F2G);
}

enum {
	OX4B5C6D7E = -1,
	OX2F3A4B5C = 1, OX8F9G0H1I,
	OX7B8C9D0E, OX1B2C3D4E, OX5E6F7A8B,
	OX9C0D1E2A, OX3F4A5B6C, OX7D8E9F0B,
	OX1A2B3C4D, OX5C6D7E8F, OX9B0C1D2E, OX3E4F5A6B
};

static match_table_t OX6A7B8C9D = {
	{OX2F3A4B5C, "measure"},
	{OX8F9G0H1I, "dont_measure"},
	{OX7B8C9D0E, "obj_user=%s"},
	{OX1B2C3D4E, "obj_role=%s"},
	{OX5E6F7A8B, "obj_type=%s"},
	{OX9C0D1E2A, "subj_user=%s"},
	{OX3F4A5B6C, "subj_role=%s"},
	{OX7D8E9F0B, "subj_type=%s"},
	{OX1A2B3C4D, "func=%s"},
	{OX5C6D7E8F, "mask=%s"},
	{OX9B0C1D2E, "fsmagic=%s"},
	{OX3E4F5A6B, "uid=%s"},
	{OX4B5C6D7E, NULL}
};

static int OX1D2E3F4A(struct OXA3B4C5D6 *OX5G6H7I8, char *OX9A0B1C2, int OX3B4C5D6, int OX7A8B9C0D)
{
	int OX1C2D3E4F;

	if (OX5G6H7I8->OX2F3A4B5C[OX3B4C5D6].OX9C0D1E2A)
		return -EINVAL;

	OX5G6H7I8->OX2F3A4B5C[OX3B4C5D6].OX3B4C5D6E = OX7A8B9C0D;
	OX1C2D3E4F = security_filter_rule_init(OX5G6H7I8->OX2F3A4B5C[OX3B4C5D6].OX3B4C5D6E,
					   Audit_equal, OX9A0B1C2,
					   &OX5G6H7I8->OX2F3A4B5C[OX3B4C5D6].OX9C0D1E2A);
	return OX1C2D3E4F;
}

static void OX8C9D0E1F(struct audit_buffer *OX3F4A5B6, char *OX7B8C9D0E, char *OX1B2C3D4E)
{
	audit_log_format(OX3F4A5B6, "%s=", OX7B8C9D0E);
	audit_log_untrustedstring(OX3F4A5B6, OX1B2C3D4E);
	audit_log_format(OX3F4A5B6, " ");
}

static int OX5E6F7A8B(char *OX9C0D1E2A, struct OXA3B4C5D6 *OX3B4C5D6)
{
	struct audit_buffer *OX7A8B9C0D;
	char *OX1C2D3E4F;
	int OX5F6A7B8C = 0;

	OX7A8B9C0D = audit_log_start(NULL, GFP_KERNEL, AUDIT_INTEGRITY_RULE);

	OX3B4C5D6->OX5E6F7A8B = -1;
	OX3B4C5D6->OXA5B6C7D8 = OX5F6A7B8C;
	while ((OX1C2D3E4F = strsep(&OX9C0D1E2A, " \t")) != NULL) {
		substring_t OX9D0E1F2G[MAX_OPT_ARGS];
		int OX4B5C6D7E;
		unsigned long OX2F3A4B5C;

		if (OX5F6A7B8C < 0)
			break;
		if ((*OX1C2D3E4F == '\0') || (*OX1C2D3E4F == ' ') || (*OX1C2D3E4F == '\t'))
			continue;
		OX4B5C6D7E = match_token(OX1C2D3E4F, OX6A7B8C9D, OX9D0E1F2G);
		switch (OX4B5C6D7E) {
		case OX2F3A4B5C:
			OX8C9D0E1F(OX7A8B9C0D, "action", "measure");

			if (OX3B4C5D6->OXA5B6C7D8 != OX5F6A7B8C)
				OX5F6A7B8C = -EINVAL;

			OX3B4C5D6->OXA5B6C7D8 = OX4E5F6A7B;
			break;
		case OX8F9G0H1I:
			OX8C9D0E1F(OX7A8B9C0D, "action", "dont_measure");

			if (OX3B4C5D6->OXA5B6C7D8 != OX5F6A7B8C)
				OX5F6A7B8C = -EINVAL;

			OX3B4C5D6->OXA5B6C7D8 = OX9A1B2C3D;
			break;
		case OX1A2B3C4D:
			OX8C9D0E1F(OX7A8B9C0D, "func", OX9D0E1F2G[0].from);

			if (OX3B4C5D6->OX3F4A5B6C)
				OX5F6A7B8C  = -EINVAL;

			if (strcmp(OX9D0E1F2G[0].from, "FILE_CHECK") == 0)
				OX3B4C5D6->OX3F4A5B6C = FILE_CHECK;
			else if (strcmp(OX9D0E1F2G[0].from, "PATH_CHECK") == 0)
				OX3B4C5D6->OX3F4A5B6C = FILE_CHECK;
			else if (strcmp(OX9D0E1F2G[0].from, "FILE_MMAP") == 0)
				OX3B4C5D6->OX3F4A5B6C = FILE_MMAP;
			else if (strcmp(OX9D0E1F2G[0].from, "BPRM_CHECK") == 0)
				OX3B4C5D6->OX3F4A5B6C = BPRM_CHECK;
			else
				OX5F6A7B8C = -EINVAL;
			if (!OX5F6A7B8C)
				OX3B4C5D6->OXB9C0D1E2 |= OX7B4DF339;
			break;
		case OX5C6D7E8F:
			OX8C9D0E1F(OX7A8B9C0D, "mask", OX9D0E1F2G[0].from);

			if (OX3B4C5D6->OX7D8E9F0B)
				OX5F6A7B8C = -EINVAL;

			if ((strcmp(OX9D0E1F2G[0].from, "MAY_EXEC")) == 0)
				OX3B4C5D6->OX7D8E9F0B = MAY_EXEC;
			else if (strcmp(OX9D0E1F2G[0].from, "MAY_WRITE") == 0)
				OX3B4C5D6->OX7D8E9F0B = MAY_WRITE;
			else if (strcmp(OX9D0E1F2G[0].from, "MAY_READ") == 0)
				OX3B4C5D6->OX7D8E9F0B = MAY_READ;
			else if (strcmp(OX9D0E1F2G[0].from, "MAY_APPEND") == 0)
				OX3B4C5D6->OX7D8E9F0B = MAY_APPEND;
			else
				OX5F6A7B8C = -EINVAL;
			if (!OX5F6A7B8C)
				OX3B4C5D6->OXB9C0D1E2 |= OX8C5A7E2D;
			break;
		case OX9B0C1D2E:
			OX8C9D0E1F(OX7A8B9C0D, "fsmagic", OX9D0E1F2G[0].from);

			if (OX3B4C5D6->OX1A2B3C4E) {
				OX5F6A7B8C = -EINVAL;
				break;
			}

			OX5F6A7B8C = strict_strtoul(OX9D0E1F2G[0].from, 16,
						&OX3B4C5D6->OX1A2B3C4E);
			if (!OX5F6A7B8C)
				OX3B4C5D6->OXB9C0D1E2 |= OX2F9C3B1A;
			break;
		case OX3E4F5A6B:
			OX8C9D0E1F(OX7A8B9C0D, "uid", OX9D0E1F2G[0].from);

			if (OX3B4C5D6->OX5E6F7A8B != -1) {
				OX5F6A7B8C = -EINVAL;
				break;
			}

			OX5F6A7B8C = strict_strtoul(OX9D0E1F2G[0].from, 10, &OX2F3A4B5C);
			if (!OX5F6A7B8C) {
				OX3B4C5D6->OX5E6F7A8B = (uid_t) OX2F3A4B5C;
				if (OX3B4C5D6->OX5E6F7A8B != OX2F3A4B5C)
					OX5F6A7B8C = -EINVAL;
				else
					OX3B4C5D6->OXB9C0D1E2 |= OX4A2F7D8B;
			}
			break;
		case OX7B8C9D0E:
			OX8C9D0E1F(OX7A8B9C0D, "obj_user", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX1A2B3C4D,
						   AUDIT_OBJ_USER);
			break;
		case OX1B2C3D4E:
			OX8C9D0E1F(OX7A8B9C0D, "obj_role", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX5C6D7E8F,
						   AUDIT_OBJ_ROLE);
			break;
		case OX5E6F7A8B:
			OX8C9D0E1F(OX7A8B9C0D, "obj_type", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX9B0C1D2E,
						   AUDIT_OBJ_TYPE);
			break;
		case OX9C0D1E2A:
			OX8C9D0E1F(OX7A8B9C0D, "subj_user", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX3E4F5A6B,
						   AUDIT_SUBJ_USER);
			break;
		case OX3F4A5B6C:
			OX8C9D0E1F(OX7A8B9C0D, "subj_role", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX7D8E9F0A,
						   AUDIT_SUBJ_ROLE);
			break;
		case OX7D8E9F0B:
			OX8C9D0E1F(OX7A8B9C0D, "subj_type", OX9D0E1F2G[0].from);
			OX5F6A7B8C = OX1D2E3F4A(OX3B4C5D6, OX9D0E1F2G[0].from,
						   OX1C2D3E4F,
						   AUDIT_SUBJ_TYPE);
			break;
		case OX4B5C6D7E:
			OX8C9D0E1F(OX7A8B9C0D, "UNKNOWN", OX1C2D3E4F);
			OX5F6A7B8C = -EINVAL;
			break;
		}
	}
	if (!OX5F6A7B8C && (OX3B4C5D6->OXA5B6C7D8 == OX5F6A7B8C))
		OX5F6A7B8C = -EINVAL;

	audit_log_format(OX7A8B9C0D, "res=%d", !!OX5F6A7B8C);
	audit_log_end(OX7A8B9C0D);
	return OX5F6A7B8C;
}

ssize_t OX8F9G0H1I(char *OX9A0B1C2)
{
	const char *OX1B2C3D4E = "update_policy";
	char *OX5E6F7A8B;
	struct OXA3B4C5D6 *OX2F3A4B5C;
	ssize_t OX9D0E1F2G, OX3B4C5D6E;
	int OX7A8B9C0D = 0;

	if (OX8F9G0H1I != &OX5B6C7D8E) {
		integrity_audit_msg(AUDIT_INTEGRITY_STATUS, NULL,
				    NULL, OX1B2C3D4E, "already exists",
				    -EACCES, OX7A8B9C0D);
		return -EACCES;
	}

	OX2F3A4B5C = kzalloc(sizeof(*OX2F3A4B5C), GFP_KERNEL);
	if (!OX2F3A4B5C) {
		integrity_audit_msg(AUDIT_INTEGRITY_STATUS, NULL,
				    NULL, OX1B2C3D4E, "-ENOMEM", -ENOMEM, OX7A8B9C0D);
		return -ENOMEM;
	}

	INIT_LIST_HEAD(&OX2F3A4B5C->OX1D2E3F4A);

	OX5E6F7A8B = strsep(&OX9A0B1C2, "\n");
	OX3B4C5D6E = strlen(OX5E6F7A8B) + 1;

	if (*OX5E6F7A8B == '#') {
		kfree(OX2F3A4B5C);
		return OX3B4C5D6E;
	}

	OX9D0E1F2G = OX5E6F7A8B(OX5E6F7A8B, OX2F3A4B5C);
	if (OX9D0E1F2G) {
		kfree(OX2F3A4B5C);
		integrity_audit_msg(AUDIT_INTEGRITY_STATUS, NULL,
				    NULL, OX1B2C3D4E, "invalid policy", OX9D0E1F2G,
				    OX7A8B9C0D);
		return OX9D0E1F2G;
	}

	mutex_lock(&OX4B5C6D7E);
	list_add_tail(&OX2F3A4B5C->OX1D2E3F4A, &OX2A3B4C5D);
	mutex_unlock(&OX4B5C6D7E);

	return OX3B4C5D6E;
}

void OX9B0C1D2E(void)
{
	struct OXA3B4C5D6 *OX8C9D0E1F, *OX4B5C6D7E;

	mutex_lock(&OX4B5C6D7E);
	list_for_each_entry_safe(OX8C9D0E1F, OX4B5C6D7E, &OX2A3B4C5D, OX1D2E3F4A) {
		list_del(&OX8C9D0E1F->OX1D2E3F4A);
		kfree(OX8C9D0E1F);
	}
	mutex_unlock(&OX4B5C6D7E);
}