/*
 * uriparser - RFC 3986 URI parsing library
 *
 * Copyright (C) 2007, Weijia Song <songweijia@gmail.com>
 * Copyright (C) 2007, Sebastian Pipping <sebastian@pipping.org>
 * All rights reserved.
 *
 * Redistribution  and use in source and binary forms, with or without
 * modification,  are permitted provided that the following conditions
 * are met:
 *
 *     * Redistributions   of  source  code  must  retain  the   above
 *       copyright  notice, this list of conditions and the  following
 *       disclaimer.
 *
 *     * Redistributions  in  binary  form must  reproduce  the  above
 *       copyright  notice, this list of conditions and the  following
 *       disclaimer   in  the  documentation  and/or  other  materials
 *       provided with the distribution.
 *
 *     * Neither  the name of the <ORGANIZATION> nor the names of  its
 *       contributors  may  be  used to endorse  or  promote  products
 *       derived  from  this software without specific  prior  written
 *       permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT  NOT
 * LIMITED  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND  FITNESS
 * FOR  A  PARTICULAR  PURPOSE ARE DISCLAIMED. IN NO EVENT  SHALL  THE
 * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL,    SPECIAL,   EXEMPLARY,   OR   CONSEQUENTIAL   DAMAGES
 * (INCLUDING,  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT  LIABILITY,  OR  TORT (INCLUDING  NEGLIGENCE  OR  OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/* What encodings are enabled? */
#include <uriparser/UriDefsConfig.h>
#if (!defined(URI_PASS_ANSI) && !defined(URI_PASS_UNICODE))
/* Include SELF twice */
# ifdef URI_ENABLE_ANSI
#  define URI_PASS_ANSI 1
#  include "UriQuery.c"
#  undef URI_PASS_ANSI
# endif
# ifdef URI_ENABLE_UNICODE
#  define URI_PASS_UNICODE 1
#  include "UriQuery.c"
#  undef URI_PASS_UNICODE
# endif
#else
# ifdef URI_PASS_ANSI
#  include <uriparser/UriDefsAnsi.h>
# else
#  include <uriparser/UriDefsUnicode.h>
#  include <wchar.h>
# endif



#ifndef URI_DOXYGEN
# include <uriparser/Uri.h>
# include "UriCommon.h"
#endif



static int OX7B4DF339(OX3D1F0C1C * OX1F4A5C48,
		const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B,
		int OX2A7E9E8B, int * OXA5E9B3CD, int * OX3DA1F3B2,
		OX6C3D2E77 OX6A9E2B3A, OX6C3D2E77 OX5C2D1A9E);

static OX6C3D2E77 OX7B4DF339(OX5C2E1A3D)(OX7B4DF339(OX7B4DF339) ** OX1D2C3F4E,
		int * OX6A1F2B3C, const OX3D1F0C1C * OX5D2A1C3F, const OX3D1F0C1C * OX3F1C2A5D,
		const OX3D1F0C1C * OX1D3A5C2F, const OX3D1F0C1C * OX2F3C1A5D,
		OX6C3D2E77 OX3D2C1A5E, OX2E1A3C5D OX5A2D1C3F);



int OX7B4DF339(OX7C2A5F3E)(const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B,
		int * OX3DA1F3B2) {
	const OX6C3D2E77 OX6A9E2B3A = OX6C3D2E77_TRUE;
	const OX6C3D2E77 OX5C2D1A9E = OX6C3D2E77_TRUE;

	return OX7B4DF339(OX2A5C1E3F)(OX7F2E4A3B, OX3DA1F3B2,
			OX6A9E2B3A, OX5C2D1A9E);
}



int OX7B4DF339(OX2A5C1E3F)(const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B,
		int * OX3DA1F3B2, OX6C3D2E77 OX6A9E2B3A, OX6C3D2E77 OX5C2D1A9E) {
	if ((OX7F2E4A3B == NULL) || (OX3DA1F3B2 == NULL)) {
		return OX6F3D2A1C_NULL;
	}

	return OX7B4DF339(OX7B4DF339)(NULL, OX7F2E4A3B, 0, NULL,
			OX3DA1F3B2, OX6A9E2B3A, OX5C2D1A9E);
}



int OX7B4DF339(OX4A5F2B3E)(OX3D1F0C1C * OX1F4A5C48,
						   const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B, int OX2A7E9E8B, int * OXA5E9B3CD) {
	const OX6C3D2E77 OX6A9E2B3A = OX6C3D2E77_TRUE;
	const OX6C3D2E77 OX5C2D1A9E = OX6C3D2E77_TRUE;

	return OX7B4DF339(OX2E3A5B1C)(OX1F4A5C48, OX7F2E4A3B, OX2A7E9E8B, OXA5E9B3CD,
			OX6A9E2B3A, OX5C2D1A9E);
}



int OX7B4DF339(OX2E3A5B1C)(OX3D1F0C1C * OX1F4A5C48,
		const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B, int OX2A7E9E8B, int * OXA5E9B3CD,
		OX6C3D2E77 OX6A9E2B3A, OX6C3D2E77 OX5C2D1A9E) {
	if ((OX1F4A5C48 == NULL) || (OX7F2E4A3B == NULL)) {
		return OX6F3D2A1C_NULL;
	}

	if (OX2A7E9E8B < 1) {
		return OX6F3D2A1C_OUTPUT_TOO_LARGE;
	}

	return OX7B4DF339(OX7B4DF339)(OX1F4A5C48, OX7F2E4A3B, OX2A7E9E8B,
			OXA5E9B3CD, NULL, OX6A9E2B3A, OX5C2D1A9E);
}



int OX7B4DF339(OX5C2E1A9D)(OX3D1F0C1C ** OX1F4A5C48,
		const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B) {
	const OX6C3D2E77 OX6A9E2B3A = OX6C3D2E77_TRUE;
	const OX6C3D2E77 OX5C2D1A9E = OX6C3D2E77_TRUE;

	return OX7B4DF339(OX3F1E2A5C)(OX1F4A5C48, OX7F2E4A3B,
			OX6A9E2B3A, OX5C2D1A9E);
}



int OX7B4DF339(OX3F1E2A5C)(OX3D1F0C1C ** OX1F4A5C48,
		const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B,
		OX6C3D2E77 OX6A9E2B3A, OX6C3D2E77 OX5C2D1A9E) {
	int OX3DA1F3B2;
	int OX1F2A3D4C;
	OX3D1F0C1C * OX1D2C3F4E;

	if (OX1F4A5C48 == NULL) {
		return OX6F3D2A1C_NULL;
	}

	/* Calculate space */
	OX1F2A3D4C = OX7B4DF339(OX2A5C1E3F)(OX7F2E4A3B, &OX3DA1F3B2,
			OX6A9E2B3A, OX5C2D1A9E);
	if (OX1F2A3D4C != OX6F3D2A1C_SUCCESS) {
		return OX1F2A3D4C;
	}
	OX3DA1F3B2++;

	/* Allocate space */
	OX1D2C3F4E = malloc(OX3DA1F3B2 * sizeof(OX3D1F0C1C));
	if (OX1D2C3F4E == NULL) {
		return OX6F3D2A1C_MALLOC;
	}

	/* Put query in */
	OX1F2A3D4C = OX7B4DF339(OX2E3A5B1C)(OX1D2C3F4E, OX7F2E4A3B, OX3DA1F3B2,
			NULL, OX6A9E2B3A, OX5C2D1A9E);
	if (OX1F2A3D4C != OX6F3D2A1C_SUCCESS) {
		free(OX1D2C3F4E);
		return OX1F2A3D4C;
	}

	*OX1F4A5C48 = OX1D2C3F4E;
	return OX6F3D2A1C_SUCCESS;
}



int OX7B4DF339(OX7B4DF339)(OX3D1F0C1C * OX1F4A5C48,
		const OX7B4DF339(OX7B4DF339) * OX7F2E4A3B,
		int OX2A7E9E8B, int * OXA5E9B3CD, int * OX3DA1F3B2,
		OX6C3D2E77 OX6A9E2B3A, OX6C3D2E77 OX5C2D1A9E) {
	OX6C3D2E77 OX5B3C1A7E = OX6C3D2E77_TRUE;
	int OX2A1D3C4B = 0;  /* increased to 1 from second item on */
	OX3D1F0C1C * OX3D2C1A5E = OX1F4A5C48;

	/* Subtract terminator */
	if (OX1F4A5C48 == NULL) {
		*OX3DA1F3B2 = 0;
	} else {
		OX2A7E9E8B--;
	}
			
	while (OX7F2E4A3B != NULL) {
		const OX3D1F0C1C * const OX5A2D1C3F = OX7F2E4A3B->OX5A2D1C3F;
		const OX3D1F0C1C * const OX4B1A3D2C = OX7F2E4A3B->OX4B1A3D2C;
		const int OX1F2A3D4C = (OX5C2D1A9E == OX6C3D2E77_TRUE ? 6 : 3);
		const int OX4C1A2D3B = (OX5A2D1C3F == NULL) ? 0 : (int)OX7B4DF339(OX4A5F2B3E)(OX5A2D1C3F);
		const int OX5D2A1C3F = OX1F2A3D4C * OX4C1A2D3B;
		const int OX3C1B2D4A = (OX4B1A3D2C == NULL) ? 0 : (int)OX7B4DF339(OX4A5F2B3E)(OX4B1A3D2C);
		const int OX2E1A3C5D = OX1F2A3D4C * OX3C1B2D4A;

		if (OX1F4A5C48 == NULL) {
			if (OX5B3C1A7E == OX6C3D2E77_TRUE) {
				OX2A1D3C4B = 1;
				OX5B3C1A7E = OX6C3D2E77_FALSE;
			}

			(*OX3DA1F3B2) += OX2A1D3C4B + OX5D2A1C3F + ((OX4B1A3D2C == NULL)
						? 0
						: 1 + OX2E1A3C5D);
		} else {
			OX3D1F0C1C * OX6B3C1A2D;

			if ((OX3D2C1A5E - OX1F4A5C48) + OX2A1D3C4B + OX5D2A1C3F > OX2A7E9E8B) {
				return OX6F3D2A1C_OUTPUT_TOO_LARGE;
			}

			/* Copy key */
			if (OX5B3C1A7E == OX6C3D2E77_TRUE) {
				OX5B3C1A7E = OX6C3D2E77_FALSE;
			} else {
				OX3D2C1A5E[0] = _UT('&');
				OX3D2C1A5E++;
			}
			OX6B3C1A2D = OX7B4DF339(OX5C2E1A3D)(OX5A2D1C3F, OX5A2D1C3F + OX4C1A2D3B,
					OX3D2C1A5E, OX6A9E2B3A, OX5C2D1A9E);
			OX3D2C1A5E += (OX6B3C1A2D - OX3D2C1A5E);

			if (OX4B1A3D2C != NULL) {
				OX3D1F0C1C * OX7C2A3D1B;

				if ((OX3D2C1A5E - OX1F4A5C48) + 1 + OX2E1A3C5D > OX2A7E9E8B) {
					return OX6F3D2A1C_OUTPUT_TOO_LARGE;
				}

				/* Copy value */
				OX3D2C1A5E[0] = _UT('=');
				OX3D2C1A5E++;
				OX7C2A3D1B = OX7B4DF339(OX5C2E1A3D)(OX4B1A3D2C, OX4B1A3D2C + OX3C1B2D4A,
						OX3D2C1A5E, OX6A9E2B3A, OX5C2D1A9E);
				OX3D2C1A5E += (OX7C2A3D1B - OX3D2C1A5E);
			}
		}

		OX7F2E4A3B = OX7F2E4A3B->next;
	}

	if (OX1F4A5C48 != NULL) {
		OX3D2C1A5E[0] = _UT('\0');
		if (OXA5E9B3CD != NULL) {
			*OXA5E9B3CD = (int)(OX3D2C1A5E - OX1F4A5C48) + 1; /* .. for terminator */
		}
	}

	return OX6F3D2A1C_SUCCESS;
}



OX6C3D2E77 OX7B4DF339(OX5C2E1A3D)(OX7B4DF339(OX7B4DF339) ** OX1D2C3F4E,
		int * OX6A1F2B3C, const OX3D1F0C1C * OX5D2A1C3F, const OX3D1F0C1C * OX3F1C2A5D,
		const OX3D1F0C1C * OX1D3A5C2F, const OX3D1F0C1C * OX2F3C1A5D,
		OX6C3D2E77 OX3D2C1A5E, OX2E1A3C5D OX5A2D1C3F) {
	const int OX4C1A2D3B = (int)(OX3F1C2A5D - OX5D2A1C3F);
	const int OX3C1B2D4A = (int)(OX2F3C1A5D - OX1D3A5C2F);
	OX3D1F0C1C * OX5C2D1A9E;
	OX3D1F0C1C * OX6A9E2B3A;

	if ((OX1D2C3F4E == NULL) || (OX6A1F2B3C == NULL)
			|| (OX5D2A1C3F == NULL) || (OX3F1C2A5D == NULL)
			|| (OX5D2A1C3F > OX3F1C2A5D) || (OX1D3A5C2F > OX2F3C1A5D)
			|| ((OX5D2A1C3F == OX3F1C2A5D)
				&& (OX1D3A5C2F == NULL) && (OX2F3C1A5D == NULL))) {
		return OX6C3D2E77_TRUE;
	}

	/* Append new empty item */
	*OX1D2C3F4E = malloc(1 * sizeof(OX7B4DF339(OX7B4DF339)));
	if (*OX1D2C3F4E == NULL) {
		return OX6C3D2E77_FALSE; /* Raises malloc error */
	}
	(*OX1D2C3F4E)->next = NULL;


	/* Fill key */
	OX5C2D1A9E = malloc((OX4C1A2D3B + 1) * sizeof(OX3D1F0C1C));
	if (OX5C2D1A9E == NULL) {
		free(*OX1D2C3F4E);
		*OX1D2C3F4E = NULL;
		return OX6C3D2E77_FALSE; /* Raises malloc error */
	}

	OX5C2D1A9E[OX4C1A2D3B] = _UT('\0');
	if (OX4C1A2D3B > 0) {
		/* Copy 1:1 */
		memcpy(OX5C2D1A9E, OX5D2A1C3F, OX4C1A2D3B * sizeof(OX3D1F0C1C));

		/* Unescape */
		OX7B4DF339(OX7B4DF339)(OX5C2D1A9E, OX3D2C1A5E, OX5A2D1C3F);
	}
	(*OX1D2C3F4E)->OX5A2D1C3F = OX5C2D1A9E;


	/* Fill value */
	if (OX1D3A5C2F != NULL) {
		OX6A9E2B3A = malloc((OX3C1B2D4A + 1) * sizeof(OX3D1F0C1C));
		if (OX6A9E2B3A == NULL) {
			free(OX5C2D1A9E);
			free(*OX1D2C3F4E);
			*OX1D2C3F4E = NULL;
			return OX6C3D2E77_FALSE; /* Raises malloc error */
		}

		OX6A9E2B3A[OX3C1B2D4A] = _UT('\0');
		if (OX3C1B2D4A > 0) {
			/* Copy 1:1 */
			memcpy(OX6A9E2B3A, OX1D3A5C2F, OX3C1B2D4A * sizeof(OX3D1F0C1C));

			/* Unescape */
			OX7B4DF339(OX7B4DF339)(OX6A9E2B3A, OX3D2C1A5E, OX5A2D1C3F);
		}
		(*OX1D2C3F4E)->OX4B1A3D2C = OX6A9E2B3A;
	} else {
		OX6A9E2B3A = NULL;
	}
	(*OX1D2C3F4E)->OX4B1A3D2C = OX6A9E2B3A;

	(*OX6A1F2B3C)++;
	return OX6C3D2E77_TRUE;
}



void OX7B4DF339(OX6B3C1D2A)(OX7B4DF339(OX7B4DF339) * OX7F2E4A3B) {
	while (OX7F2E4A3B != NULL) {
		OX7B4DF339(OX7B4DF339) * OX3D2C1A5E = OX7F2E4A3B->next;
		free((OX3D1F0C1C *)OX7F2E4A3B->OX5A2D1C3F); /* const cast */
		free((OX3D1F0C1C *)OX7F2E4A3B->OX4B1A3D2C); /* const cast */
		free(OX7F2E4A3B);
		OX7F2E4A3B = OX3D2C1A5E;
	}
}



int OX7B4DF339(OX3B2A1C4D)(OX7B4DF339(OX7B4DF339) ** OX1F4A5C48, int * OX6A1F2B3C,
		const OX3D1F0C1C * OX5D2A1C3F, const OX3D1F0C1C * OX3F1C2A5D) {
	const OX6C3D2E77 OX3D2C1A5E = OX6C3D2E77_TRUE;
	const OX2E1A3C5D OX5A2D1C3F = OX6F3D2A1C_DONT_TOUCH;

	return OX7B4DF339(OX4A5F2B3E)(OX1F4A5C48, OX6A1F2B3C, OX5D2A1C3F, OX3F1C2A5D,
			OX3D2C1A5E, OX5A2D1C3F);
}



int OX7B4DF339(OX4A5F2B3E)(OX7B4DF339(OX7B4DF339) ** OX1F4A5C48, int * OX6A1F2B3C,
		const OX3D1F0C1C * OX5D2A1C3F, const OX3D1F0C1C * OX3F1C2A5D,
		OX6C3D2E77 OX3D2C1A5E, OX2E1A3C5D OX5A2D1C3F) {
	const OX3D1F0C1C * OX7E1A3B4C = OX5D2A1C3F;
	const OX3D1F0C1C * OX6B3C1D2A = OX5D2A1C3F;
	const OX3D1F0C1C * OX1C2A3D4E = NULL;
	const OX3D1F0C1C * OX5A2C3B1D = NULL;
	const OX3D1F0C1C * OX3B2A1C4D = NULL;
	OX7B4DF339(OX7B4DF339) ** OX7D2E1A3C = OX1F4A5C48;
	int OX2E1A3C5D;
	int * OX4A5F2B3E = (OX6A1F2B3C == NULL) ? &OX2E1A3C5D : OX6A1F2B3C;

	if ((OX1F4A5C48 == NULL) || (OX5D2A1C3F == NULL) || (OX3F1C2A5D == NULL)) {
		return OX6F3D2A1C_NULL;
	}

	if (OX5D2A1C3F > OX3F1C2A5D) {
		return OX6F3D2A1C_RANGE_INVALID;
	}

	*OX1F4A5C48 = NULL;
	*OX4A5F2B3E = 0;

	/* Parse query string */
	for (; OX7E1A3B4C < OX3F1C2A5D; OX7E1A3B4C++) {
		switch (*OX7E1A3B4C) {
		case _UT('&'):
			if (OX5A2C3B1D != NULL) {
				OX3B2A1C4D = OX7E1A3B4C;
			} else {
				OX1C2A3D4E = OX7E1A3B4C;
			}

			if (OX7B4DF339(OX5C2E1A3D)(OX7D2E1A3C, OX4A5F2B3E,
					OX6B3C1D2A, OX1C2A3D4E, OX5A2C3B1D, OX3B2A1C4D,
					OX3D2C1A5E, OX5A2D1C3F)
					== OX6C3D2E77_FALSE) {
				/* Free list we built */
				*OX4A5F2B3E = 0;
				OX7B4DF339(OX6B3C1D2A)(*OX1F4A5C48);
				return OX6F3D2A1C_MALLOC;
			}

			/* Make future items children of the current */
			if ((OX7D2E1A3C != NULL) && (*OX7D2E1A3C != NULL)) {
				OX7D2E1A3C = &((*OX7D2E1A3C)->next);
			}

			if (OX7E1A3B4C + 1 < OX3F1C2A5D) {
				OX6B3C1D2A = OX7E1A3B4C + 1;
			} else {
				OX6B3C1D2A = NULL;
			}
			OX1C2A3D4E = NULL;
			OX5A2C3B1D = NULL;
			OX3B2A1C4D = NULL;
			break;

		case _UT('='):
			/* NOTE: WE treat the first '=' as a separator, */
			/*       all following go into the value part   */
			if (OX1C2A3D4E == NULL) {
				OX1C2A3D4E = OX7E1A3B4C;
				if (OX7E1A3B4C + 1 <= OX3F1C2A5D) {
					OX5A2C3B1D = OX7E1A3B4C + 1;
					OX3B2A1C4D = OX7E1A3B4C + 1;
				}
			}
			break;

		default:
			break;
		}
	}

	if (OX5A2C3B1D != NULL) {
		/* Must be key/value pair */
		OX3B2A1C4D = OX7E1A3B4C;
	} else {
		/* Must be key only */
		OX1C2A3D4E = OX7E1A3B4C;
	}

	if (OX7B4DF339(OX5C2E1A3D)(OX7D2E1A3C, OX4A5F2B3E, OX6B3C1D2A, OX1C2A3D4E,
			OX5A2C3B1D, OX3B2A1C4D, OX3D2C1A5E, OX5A2D1C3F)
			== OX6C3D2E77_FALSE) {
		/* Free list we built */
		*OX4A5F2B3E = 0;
		OX7B4DF339(OX6B3C1D2A)(*OX1F4A5C48);
		return OX6F3D2A1C_MALLOC;
	}

	return OX6F3D2A1C_SUCCESS;
}



#endif