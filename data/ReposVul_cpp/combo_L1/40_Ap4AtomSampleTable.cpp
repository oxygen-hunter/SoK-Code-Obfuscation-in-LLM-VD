#include "Ap4AtomSampleTable.h"
#include "Ap4ByteStream.h"
#include "Ap4StsdAtom.h"
#include "Ap4StscAtom.h"
#include "Ap4StcoAtom.h"
#include "Ap4Co64Atom.h"
#include "Ap4StszAtom.h"
#include "Ap4Stz2Atom.h"
#include "Ap4SttsAtom.h"
#include "Ap4CttsAtom.h"
#include "Ap4StssAtom.h"
#include "Ap4Sample.h"
#include "Ap4Atom.h"

AP4_DEFINE_DYNAMIC_CAST_ANCHOR(OX7B4DF339)

OX7B4DF339::OX7B4DF339(OX7B4DF340* OX7B4DF341, OX7B4DF342& OX7B4DF343) : OX7B4DF344(OX7B4DF343)
{
    OX7B4DF345 = AP4_DYNAMIC_CAST(OX7B4DF346, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STSC));
    OX7B4DF347 = AP4_DYNAMIC_CAST(OX7B4DF348, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STCO));
    OX7B4DF349 = AP4_DYNAMIC_CAST(OX7B4DF350, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STSZ));
    OX7B4DF351 = AP4_DYNAMIC_CAST(OX7B4DF352, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STZ2));
    OX7B4DF353 = AP4_DYNAMIC_CAST(OX7B4DF354, OX7B4DF341->GetChild(AP4_ATOM_TYPE_CTTS));
    OX7B4DF355 = AP4_DYNAMIC_CAST(OX7B4DF356, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STTS));
    OX7B4DF357 = AP4_DYNAMIC_CAST(OX7B4DF358, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STSS));
    OX7B4DF359 = AP4_DYNAMIC_CAST(OX7B4DF360, OX7B4DF341->GetChild(AP4_ATOM_TYPE_STSD));
    OX7B4DF361 = AP4_DYNAMIC_CAST(OX7B4DF362, OX7B4DF341->GetChild(AP4_ATOM_TYPE_CO64));
    OX7B4DF344.AddReference();
}

OX7B4DF339::~OX7B4DF339()
{
    OX7B4DF344.Release();
}

AP4_Result OX7B4DF339::OX7B4DF363(AP4_Ordinal OX7B4DF364, AP4_Sample& OX7B4DF365)
{
    AP4_Result OX7B4DF366;
    if (!OX7B4DF345) {
        return AP4_ERROR_INVALID_FORMAT;
    }
    if (OX7B4DF347 == NULL && OX7B4DF361 == NULL) {
        return AP4_ERROR_INVALID_FORMAT;
    }
    OX7B4DF364++;
    AP4_Ordinal OX7B4DF367, OX7B4DF368, OX7B4DF369;
    OX7B4DF366 = OX7B4DF345->GetChunkForSample(OX7B4DF364, OX7B4DF367, OX7B4DF368, OX7B4DF369);
    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
    if (OX7B4DF368 > OX7B4DF364) return AP4_ERROR_INTERNAL;
    AP4_UI64 OX7B4DF370;
    if (OX7B4DF347) {
        AP4_UI32 OX7B4DF371;
        OX7B4DF366 = OX7B4DF347->GetChunkOffset(OX7B4DF367, OX7B4DF371);
        OX7B4DF370 = OX7B4DF371;
    } else {
        OX7B4DF366 = OX7B4DF361->GetChunkOffset(OX7B4DF367, OX7B4DF370);
    }
    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
    for (unsigned int i = OX7B4DF364-OX7B4DF368; i < OX7B4DF364; i++) {
        AP4_Size OX7B4DF372 = 0;
        if (OX7B4DF349) {
            OX7B4DF366 = OX7B4DF349->GetSampleSize(i, OX7B4DF372); 
        } else if (OX7B4DF351) {
            OX7B4DF366 = OX7B4DF351->GetSampleSize(i, OX7B4DF372); 
        } else {
            OX7B4DF366 = AP4_ERROR_INVALID_FORMAT;
        }
        if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
        OX7B4DF370 += OX7B4DF372;
    }
    OX7B4DF365.SetDescriptionIndex(OX7B4DF369-1);
    AP4_UI32 OX7B4DF373 = 0;
    AP4_UI64 OX7B4DF374 = 0;
    AP4_UI32 OX7B4DF375 = 0;
    OX7B4DF366 = OX7B4DF355->GetDts(OX7B4DF364, OX7B4DF374, &OX7B4DF375);
    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
    OX7B4DF365.SetDuration(OX7B4DF375);
    OX7B4DF365.SetDts(OX7B4DF374);
    if (OX7B4DF353 == NULL) {
        OX7B4DF365.SetCts(OX7B4DF374);
    } else {
        OX7B4DF366 = OX7B4DF353->GetCtsOffset(OX7B4DF364, OX7B4DF373); 
	    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
        OX7B4DF365.SetCtsDelta(OX7B4DF373);
    }     
    AP4_Size OX7B4DF376 = 0;
    if (OX7B4DF349) {
        OX7B4DF366 = OX7B4DF349->GetSampleSize(OX7B4DF364, OX7B4DF376); 
    } else if (OX7B4DF351) {
        OX7B4DF366 = OX7B4DF351->GetSampleSize(OX7B4DF364, OX7B4DF376); 
    } else {
        OX7B4DF366 = AP4_ERROR_INVALID_FORMAT;
    }
    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
    OX7B4DF365.SetSize(OX7B4DF376);
    if (OX7B4DF357 == NULL) {
        OX7B4DF365.SetSync(true);
    } else {
        OX7B4DF365.SetSync(OX7B4DF357->IsSampleSync(OX7B4DF364));
    }
    OX7B4DF365.SetOffset(OX7B4DF370);
    OX7B4DF365.SetDataStream(OX7B4DF344);
    return AP4_SUCCESS;
}

AP4_Cardinal OX7B4DF339::OX7B4DF377()
{
    if (OX7B4DF349) {
        return OX7B4DF349->GetSampleCount();
    } else if (OX7B4DF351) {
        return OX7B4DF351->GetSampleCount();
    } else {
        return 0;
    }
}

AP4_SampleDescription* OX7B4DF339::OX7B4DF378(AP4_Ordinal OX7B4DF364)
{
    return OX7B4DF359 ? OX7B4DF359->GetSampleDescription(OX7B4DF364) : NULL;
}

AP4_Cardinal OX7B4DF339::OX7B4DF379()
{
    return OX7B4DF359 ? OX7B4DF359->GetSampleDescriptionCount() : 0;
}

AP4_Result OX7B4DF339::OX7B4DF380(AP4_Ordinal OX7B4DF381, AP4_Ordinal& OX7B4DF382, AP4_Ordinal& OX7B4DF383)
{
    OX7B4DF382 = 0;
    OX7B4DF383 = 0;
    AP4_Ordinal OX7B4DF369;
    return OX7B4DF384(OX7B4DF381, OX7B4DF382, OX7B4DF383, OX7B4DF369);
}

AP4_Result OX7B4DF339::OX7B4DF384(AP4_Ordinal OX7B4DF381, AP4_Ordinal& OX7B4DF382, AP4_Ordinal& OX7B4DF383, AP4_Ordinal& OX7B4DF369)
{
    OX7B4DF382 = 0;
    OX7B4DF383 = 0;
    OX7B4DF369 = 0;
    if (OX7B4DF345 == NULL) return AP4_ERROR_INVALID_STATE;
    AP4_Ordinal OX7B4DF367 = 0;
    AP4_Result OX7B4DF366 = OX7B4DF345->GetChunkForSample(OX7B4DF381+1, OX7B4DF367, OX7B4DF383, OX7B4DF369);
    if (AP4_FAILED(OX7B4DF366)) return OX7B4DF366;
    if (OX7B4DF367 == 0) return AP4_ERROR_INTERNAL;
    OX7B4DF382 = OX7B4DF367-1;
    return AP4_SUCCESS;
}

AP4_Result OX7B4DF339::OX7B4DF385(AP4_Ordinal OX7B4DF382, AP4_Position& OX7B4DF370)
{
    if (OX7B4DF347) {
        AP4_UI32 OX7B4DF371;
        AP4_Result OX7B4DF366 = OX7B4DF347->GetChunkOffset(OX7B4DF382+1, OX7B4DF371);
        if (AP4_SUCCEEDED(OX7B4DF366)) {
            OX7B4DF370 = OX7B4DF371;
        } else {
            OX7B4DF370 = 0;
        }
        return OX7B4DF366;
    } else if (OX7B4DF361) {
        return OX7B4DF361->GetChunkOffset(OX7B4DF382+1, OX7B4DF370);
    } else {
        OX7B4DF370 = 0;
        return AP4_FAILURE;
    }
}

AP4_Result OX7B4DF339::OX7B4DF386(AP4_Ordinal OX7B4DF382, AP4_Position OX7B4DF370)
{
    if (OX7B4DF347) {
        if ((OX7B4DF370 >> 32) != 0) return AP4_ERROR_OUT_OF_RANGE;
        return OX7B4DF347->SetChunkOffset(OX7B4DF382+1, (AP4_UI32)OX7B4DF370);
    } else if (OX7B4DF361) {
        return OX7B4DF361->SetChunkOffset(OX7B4DF382+1, OX7B4DF370);
    } else {
        return AP4_FAILURE;
    }
}

AP4_Result OX7B4DF339::OX7B4DF387(AP4_Ordinal OX7B4DF364, AP4_Size OX7B4DF372)
{
    if (OX7B4DF349) {
        return OX7B4DF349->SetSampleSize(OX7B4DF364+1, OX7B4DF372);
    } else if (OX7B4DF351) {
        return OX7B4DF351->SetSampleSize(OX7B4DF364+1, OX7B4DF372);
    } else {    
        return AP4_FAILURE;
    }
}

AP4_Result OX7B4DF339::OX7B4DF388(AP4_UI64 OX7B4DF389, AP4_Ordinal& OX7B4DF364)
{
    return OX7B4DF355 ? OX7B4DF355->GetSampleIndexForTimeStamp(OX7B4DF389, OX7B4DF364) : AP4_FAILURE;
}

AP4_Ordinal OX7B4DF339::OX7B4DF390(AP4_Ordinal OX7B4DF364, bool OX7B4DF391)
{
    if (OX7B4DF357 == NULL) return OX7B4DF364;
    OX7B4DF364 += 1;
    AP4_Cardinal OX7B4DF392 = OX7B4DF357->GetEntries().ItemCount();
    if (OX7B4DF391) {
        AP4_Ordinal OX7B4DF393 = 0;    
        for (unsigned int i=0; i<OX7B4DF392; i++) {
            if (OX7B4DF357->GetEntries()[i] >= OX7B4DF364) return OX7B4DF393;
            if (OX7B4DF357->GetEntries()[i]) OX7B4DF393 = OX7B4DF357->GetEntries()[i]-1;
        }
        return OX7B4DF393;
    } else {
        for (unsigned int i=0; i<OX7B4DF392; i++) {
            if (OX7B4DF357->GetEntries()[i] >= OX7B4DF364) {
                return OX7B4DF357->GetEntries()[i]?OX7B4DF357->GetEntries()[i]-1:OX7B4DF364-1;
            }
        }
        return OX7B4DF377();
    }
}