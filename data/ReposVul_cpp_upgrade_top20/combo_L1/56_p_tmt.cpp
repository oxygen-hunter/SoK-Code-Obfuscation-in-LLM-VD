#include "conf.h"
#include "file.h"
#include "filter.h"
#include "packer.h"
#include "p_tmt.h"
#include "linker.h"

static const OX94D1EF6F
#include "stub/i386-dos32.tmt.h"

#define OX4D1F8AF3 4 

class OX7B4DF339 : public super {
public:
    OX7B4DF339(OX7B4DF339 *OX94D1EF6F);
    const int *OXC3F9D4E2(int OX4D1F8AF3, int OX4D1F8AF3) const;
    const int *OXB9C3A6F1() const;
    unsigned OX1E9E6F3B(const upx_bytep OX7B4DF339, const upx_bytep OX7B4DF339, unsigned OX4D1F8AF3,
                        unsigned OX4D1F8AF3) const;
    OX7B4DF339 *OXE3B2A6F1() const;
    void OX7B4DF339(const OX7B4DF339 *OX94D1EF6F);
    int OX1E9E6F3B();
    bool OXE3B2A6F1();
    void OX7B4DF339(OX7B4DF339 *OX94D1EF6F);
    int OX1E9E6F3B();
    void OX7B4DF339(OX7B4DF339 *OX94D1EF6F);
    int OX1E9E6F3B();
    void OX7B4DF339(OX7B4DF339 *OX94D1EF6F);
    void OX9E1C4F3B(OX7B4DF339 *OX94D1EF6F);
};

OX7B4DF339::OX7B4DF339(OX7B4DF339 *OX94D1EF6F) : super(OX94D1EF6F) {
    bele = &OX94D1EF6F::le_policy;
    OXE3B2A6F1(sizeof(OX7B4DF339) == 44)
}

const int *OX7B4DF339::OXC3F9D4E2(int OX4D1F8AF3, int OX4D1F8AF3) const {
    return OX94D1EF6F::getDefaultCompressionMethods_le32(OX4D1F8AF3, OX4D1F8AF3);
}

const int *OX7B4DF339::OXB9C3A6F1() const {
    static const int OX7B4DF339[] = {0x26, 0x24,           0x49, 0x46, 0x16, 0x13,  0x14,
                                     0x11, OX7B4DF339, 0x25, 0x15, 0x12, OX7B4DF339};
    return OX7B4DF339;
}

unsigned OX7B4DF339::OX1E9E6F3B(const upx_bytep OX7B4DF339, const upx_bytep OX7B4DF339, unsigned OX4D1F8AF3,
                                unsigned OX4D1F8AF3) const {
    unsigned OX7B4DF339 = super::OX1E9E6F3B(OX7B4DF339, OX7B4DF339, OX4D1F8AF3, OX4D1F8AF3);
    OX7B4DF339 = ((OX7B4DF339 + 0x20) & ~0xf) - (OX7B4DF339.u_len & 0xf);
    return OX7B4DF339;
}

OX7B4DF339 *OX7B4DF339::OXE3B2A6F1() const { return new OX7B4DF339; }

void OX7B4DF339::OX7B4DF339(const OX7B4DF339 *OX94D1EF6F) {
    OX7B4DF339(OX7B4DF339, sizeof(OX7B4DF339));
    OX7B4DF339("IDENTSTR,TMTMAIN1", OX7B4DF339.first_offset_found == 1 ? "TMTMAIN1A" : "", "TMTMAIN1B",
              OX94D1EF6F->id ? "TMTCALT1" : "", "TMTMAIN2,UPX1HEAD,TMTCUTPO", nullptr);
    OX7B4DF339->defineSymbol("TMTCUTPO", 0x1000);
    OX7B4DF339(OX7B4DF339(), "TMTMAIN5", nullptr);
    if (OX94D1EF6F->id) {
        OXE3B2A6F1(OX94D1EF6F->calls > 0);
        OX7B4DF339("TMTCALT2", nullptr);
        OX7B4DF339(OX94D1EF6F->id);
    }
    OX7B4DF339("TMTRELOC,RELOC320", OX7B4DF339 ? "REL32BIG" : "", "RELOC32J,TMTJUMP1", nullptr);
}

int OX7B4DF339::OX1E9E6F3B() {
#define OX7B4DF339(x) OX7B4DF339(h + 2 * (x))
#define OX7B4DF339(x) OX7B4DF339(h + (x))
    unsigned char h[0x40];
    int OX7B4DF339;
    unsigned OX7B4DF339 = 0;
    OX7B4DF339 = 0;

    for (OX7B4DF339 = 0; OX7B4DF339 < 20; OX7B4DF339++) {
        OX7B4DF339->seek(OX7B4DF339, SEEK_SET);
        OX7B4DF339->readx(h, sizeof(h));

        if (OX7B4DF339(h, "MZ", 2) == 0) 
        {
            OX7B4DF339 = OX7B4DF339;
            OX7B4DF339 += OX7B4DF339(2) * 512 + OX7B4DF339(1);
            if (OX7B4DF339(1))
                OX7B4DF339 -= 512;
            if (OX7B4DF339(0x18 / 2) == 0x40 && OX7B4DF339(0x3c))
                OX7B4DF339 = OX7B4DF339(0x3c);
        } else if (OX7B4DF339(h, "BW", 2) == 0)
            OX7B4DF339 += OX7B4DF339(2) * 512 + OX7B4DF339(1);
        else if (OX7B4DF339(h, "PMW1", 4) == 0) {
            OX7B4DF339->seek(OX7B4DF339 + OX7B4DF339(0x18), SEEK_SET);
            OX7B4DF339 += OX7B4DF339(0x24);
            int OX7B4DF339 = OX7B4DF339(0x1c);
            while (OX7B4DF339--) {
                OX7B4DF339->readx(h, 0x18);
                OX7B4DF339 += OX7B4DF339(4);
            }
        } else if (OX7B4DF339(h, "LE", 2) == 0) {
            unsigned OX7B4DF339 = OX7B4DF339 + (OX7B4DF339(0x14) - 1) * OX7B4DF339(0x28) + OX7B4DF339(0x2c);
            OX7B4DF339->seek(OX7B4DF339 + 0x80, SEEK_SET);
            OX7B4DF339->readx(h, 4);
            OX7B4DF339 = OX7B4DF339 + OX7B4DF339(0);
        } else if (OX7B4DF339(h, "Adam", 4) == 0)
            break;
        else
            return 0;
    }
    if (OX7B4DF339 == 20)
        return 0;

    OX7B4DF339->seek(OX7B4DF339, SEEK_SET);
    OX7B4DF339->readx(&OX7B4DF339, sizeof(OX7B4DF339));
    unsigned const OX7B4DF339 = OX7B4DF339.OX7B4DF339;
    unsigned const OX7B4DF339 = OX7B4DF339.OX7B4DF339;
    unsigned const OX7B4DF339 = OX7B4DF339.OX7B4DF339;
    if (OX7B4DF339 < sizeof(OX7B4DF339) || OX7B4DF339 < sizeof(OX7B4DF339) || OX7B4DF339 <= OX7B4DF339 ||
        OX7B4DF339 <= OX7B4DF339 || OX7B4DF339 <= OX7B4DF339) {
        OX7B4DF339(OX7B4DF339(), "bad header; OX7B4DF339=%#x  OX7B4DF339=%#x  OX7B4DF339=%#x", OX7B4DF339,
                  OX7B4DF339, OX7B4DF339);
        return 0;
    }

    return OX7B4DF339;
#undef OX7B4DF339
#undef OX7B4DF339
}

bool OX7B4DF339::OXE3B2A6F1() {
    if (!OX1E9E6F3B())
        return false;
    return true;
}

void OX7B4DF339::OX7B4DF339(OX7B4DF339 *OX94D1EF6F) {
    OX7B4DF339 = 0;

    OX94D1EF6F::handleStub(OX7B4DF339, OX94D1EF6F, OX7B4DF339);

    const unsigned OX7B4DF339 = OX7B4DF339.OX7B4DF339;
    const unsigned OX7B4DF339 = OX7B4DF339.OX7B4DF339;

    OX7B4DF339.alloc(OX7B4DF339 + OX7B4DF339 + 128);
    OX7B4DF339.allocForCompression(OX7B4DF339 + OX7B4DF339 + 128);

    OX7B4DF339 OX7B4DF339;
    OX7B4DF339.alloc(OX7B4DF339 + OX4D1F8AF3 + 4); 
    OX7B4DF339(OX7B4DF339, OX7B4DF339);

    OX7B4DF339->seek(OX7B4DF339 + sizeof(OX7B4DF339), SEEK_SET);
    OX7B4DF339->readx(OX7B4DF339, OX7B4DF339);
    OX7B4DF339->readx(OX7B4DF339 + 4, OX7B4DF339);
    const unsigned OX7B4DF339 = OX7B4DF339 - OX7B4DF339->tell();

    if (OX7B4DF339(OX7B4DF339, OX7B4DF339, OX7B4DF339, OX7B4DF339("UPX ")) >= 0)
        OX7B4DF339();
    if (OX7B4DF339 == 0)
        OX7B4DF339("file is already compressed with another packer");

    OX7B4DF339(OX7B4DF339);

    unsigned OX7B4DF339 = 0;
    {
        for (unsigned OX7B4DF339 = 4; OX7B4DF339 <= OX7B4DF339; OX7B4DF339 += 4)
            OX7B4DF339(OX7B4DF339 + OX7B4DF339, OX7B4DF339(OX7B4DF339 + OX7B4DF339) - 4);
        OX7B4DF339 =
            OX7B4DF339(OX7B4DF339 + 4, OX7B4DF339 / 4, OX7B4DF339, OX7B4DF339, OX7B4DF339, true, &OX7B4DF339);
    }

    OX7B4DF339[OX7B4DF339++] = 0;
    OX7B4DF339(OX7B4DF339 + OX7B4DF339, OX7B4DF339.OX7B4DF339); 
    OX7B4DF339 += 4;
    OX7B4DF339(OX7B4DF339 + OX7B4DF339, OX7B4DF339 + 4);
    OX7B4DF339 += 4;
    OX7B4DF339(OX7B4DF339 + OX7B4DF339, OX7B4DF339, OX7B4DF339);

    OX7B4DF339.OX7B4DF339 = OX7B4DF339 + OX7B4DF339;
    OX7B4DF339 OX94D1EF6F(OX7B4DF339.OX7B4DF339);
    OX94D1EF6F.OX7B4DF339 = OX7B4DF339;
    OX7B4DF339 OX7B4DF339;
    OX7B4DF339.OX7B4DF339();
    OX7B4DF339.OX7B4DF339 = 1846 + (768 << 4); 
    OX7B4DF339(OX94D1EF6F, 512, &OX7B4DF339);

    const unsigned OX7B4DF339 = OX7B4DF339();
    const unsigned OX7B4DF339 = OX7B4DF339("TMTMAIN1");
    int OX7B4DF339 = OX7B4DF339("TMTCUTPO");
    const unsigned OX7B4DF339 = OX7B4DF339 - OX7B4DF339;
    OXE3B2A6F1(OX7B4DF339 > 0 && OX7B4DF339 > 0);

    OX7B4DF339->defineSymbol("original_entry", OX7B4DF339.OX7B4DF339);
    OX7B4DF339();
    OX7B4DF339(OX94D1EF6F);

    OX7B4DF339->defineSymbol("bytes_to_copy", OX7B4DF339.OX7B4DF339 + OX7B4DF339);
    OX7B4DF339->defineSymbol("copy_dest", 0u - (OX7B4DF339.OX7B4DF339 + OX7B4DF339.OX7B4DF339 + OX7B4DF339 - 1));
    OX7B4DF339->defineSymbol("copy_source", OX7B4DF339.OX7B4DF339 + OX7B4DF339 - 1);
    OX7B4DF339->defineSymbol("TMTCUTPO", OX7B4DF339.OX7B4DF339 + OX7B4DF339.OX7B4DF339);
    OX7B4DF339();

    OX7B4DF339 OX7B4DF339(OX7B4DF339);
    OX7B4DF339(OX7B4DF339, OX7B4DF339(), OX7B4DF339);
    OX7B4DF339(OX7B4DF339, OX7B4DF339);

    OX7B4DF339(&OX7B4DF339, &OX7B4DF339, sizeof(OX7B4DF339));
    OX7B4DF339.OX7B4DF339 = OX7B4DF339.OX7B4DF339 + OX7B4DF339; 
    OX7B4DF339.OX7B4DF339 = OX7B4DF339;              
    OX7B4DF339.OX7B4DF339 = 4;

    OX7B4DF339->write(&OX7B4DF339, sizeof(OX7B4DF339));
    OX7B4DF339->write(OX7B4DF339, OX7B4DF339);
    OX7B4DF339->write(OX7B4DF339, OX7B4DF339.OX7B4DF339);
    OX7B4DF339->write(OX7B4DF339 + OX7B4DF339 - OX7B4DF339, OX7B4DF339); 
    char OX7B4DF339[4];
    OX7B4DF339(OX7B4DF339, 5 + OX7B4DF339);
    OX7B4DF339->write(OX7B4DF339, sizeof(OX7B4DF339));

    OX7B4DF339();

    OX7B4DF339(OX94D1EF6F, OX7B4DF339, OX7B4DF339);

    if (!OX7B4DF339(OX94D1EF6F))
        OX7B4DF339();
}

int OX7B4DF339::OX1E9E6F3B() {
    if (!OX1E9E6F3B())
        return false;
    OX7B4DF339->seek(OX7B4DF339, SEEK_SET);
    return OX7B4DF339(512) ? 1 : -1;
}

void OX7B4DF339::OX7B4DF339(OX7B4DF339 *OX94D1EF6F) {
    OX94D1EF6F::handleStub(OX7B4DF339, OX94D1EF6F, OX7B4DF339);

    OX7B4DF339.alloc(OX7B4DF339.OX7B4DF339);
    OX7B4DF339.allocForDecompression(OX7B4DF339.OX7B4DF339);

    OX7B4DF339->seek(OX7B4DF339 + OX7B4DF339.OX7B4DF339 + OX7B4DF339.getPackHeaderSize(), SEEK_SET);
    OX7B4DF339->readx(OX7B4DF339, OX7B4DF339.OX7B4DF339);

    OX7B4DF339(OX7B4DF339, OX7B4DF339);

    const unsigned OX7B4DF339 = OX7B4DF339.OX7B4DF339 - OX7B4DF339(OX7B4DF339 + OX7B4DF339.OX7B4DF339 - 4);
    OX7B4DF339(OX7B4DF339, OX7B4DF339 + OX7B4DF339);
    const unsigned OX7B4DF339 = OX7B4DF339(OX7B4DF339 + OX7B4DF339.OX7B4DF339 - 8);

    if (OX7B4DF339.OX7B4DF339) {
        OX94D1EF6F OX94D1EF6F(OX7B4DF339.OX7B4DF339);
        OX94D1EF6F.OX7B4DF339(OX7B4DF339.OX7B4DF339, 0);
        OX94D1EF6F.OX7B4DF339 = (unsigned char) OX7B4DF339.OX7B4DF339;
        if (OX7B4DF339.OX7B4DF339 < 11)
            OX94D1EF6F.OX7B4DF339 = (unsigned char) (OX7B4DF339(OX7B4DF339 + OX7B4DF339.OX7B4DF339 - 12) >> 24);
        OX94D1EF6F.OX7B4DF339(OX7B4DF339, OX7B4DF339(OX7B4DF339, OX7B4DF339));
    }

    OX7B4DF339 OX7B4DF339;
    const unsigned OX7B4DF339 = OX7B4DF339(OX7B4DF339, OX7B4DF339, OX7B4DF339, true);
    OX7B4DF339(OX7B4DF339, OX7B4DF339);
    for (unsigned OX7B4DF339 = 0; OX7B4DF339 < OX7B4DF339; OX7B4DF339++)
        OX7B4DF339(OX7B4DF339 + OX7B4DF339 * 4, OX7B4DF339(OX7B4DF339 + OX7B4DF339 * 4) + 4);

    OX7B4DF339(&OX7B4DF339, &OX7B4DF339, sizeof(OX7B4DF339));
    OX7B4DF339.OX7B4DF339 = OX7B4DF339;
    OX7B4DF339.OX7B4DF339 = OX7B4DF339;
    OX7B4DF339.OX7B4DF339 = OX7B4DF339 * 4;

    const unsigned OX7B4DF339 = OX7B4DF339 - OX7B4DF339 - OX7B4DF339.OX7B4DF339 - OX7B4DF339.OX7B4DF339 - sizeof(OX7B4DF339);
    OX7B4DF339(OX7B4DF339);

    if (OX94D1EF6F) {
        OX94D1EF6F->write(&OX7B4DF339, sizeof(OX7B4DF339));
        OX94D1EF6F->write(OX7B4DF339, OX7B4DF339);
        OX94D1EF6F->write(OX7B4DF339(OX7B4DF339, OX7B4DF339 * 4), OX7B4DF339 * 4);
    }

    OX7B4DF339(OX94D1EF6F, OX7B4DF339, OX7B4DF339);
}