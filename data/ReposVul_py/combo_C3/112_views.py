from django.shortcuts import render
from django.views.generic import TemplateView, View
from haystack.query import SearchQuerySet
from haystack.utils.geo import Point
from django.http import HttpResponse
from django.contrib.gis.measure import D
from django.contrib.gis.geos import GEOSGeometry
from django.db import connection
from Data.models import BestBikeTrails, MinnesotaBikeTrails
from requests import get
import xml.etree.ElementTree as ET
from json import dumps, loads

class VM:
    def __init__(self):
        self.stack = []
        self.pc = 0
        self.instructions = []
        self.running = True

    def run(self):
        while self.running:
            opcode, *args = self.instructions[self.pc]
            self.pc += 1
            getattr(self, opcode)(*args)

    def PUSH(self, value):
        self.stack.append(value)

    def POP(self):
        return self.stack.pop()

    def ADD(self):
        b = self.POP()
        a = self.POP()
        self.PUSH(a + b)

    def SUB(self):
        b = self.POP()
        a = self.POP()
        self.PUSH(a - b)

    def LOAD(self, index):
        self.PUSH(self.stack[index])

    def STORE(self, index):
        self.stack[index] = self.POP()

    def JMP(self, index):
        self.pc = index

    def JZ(self, index):
        if self.POP() == 0:
            self.pc = index

    def HALT(self):
        self.running = False

def compile_MainPage(vm):
    vm.instructions = [
        ('PUSH', 'index.html'),
        ('PUSH', render),
        ('HALT',)
    ]

def compile_SearchAjax(vm, request):
    vm.instructions = [
        ('PUSH', request.GET.get('lat', '')),
        ('PUSH', float),
        ('LOAD', 1),
        ('PUSH', request.GET.get('lng', '')),
        ('PUSH', float),
        ('LOAD', 3),
        ('PUSH', SearchQuerySet().filter(content_auto=request.GET.get('q', '')).distance('geometry', Point(vm.stack[3], vm.stack[1], srid=4326)).order_by('distance')),
        ('LOAD', 5),
        ('PUSH', 6),
        ('SUB',),
        ('JZ', 13),
        ('PUSH', vm.stack[5][:5]),
        ('STORE', 5),
        ('LOAD', 5),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 21),
        ('LOAD', 5),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 21),
        ('PUSH', ()),
        ('STORE', 7),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda q: (q.content_auto, " " + ("%.2f" % (q.distance.m if q.distance.m < 1000 else q.distance.mi)) + (" meters" if q.distance.m < 1000 else " miles"), q.source, q.target, GEOSGeometry(q.geometry).coords[1], GEOSGeometry(q.geometry).coords[0])),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('PUSH', dumps),
        ('PUSH', 'application/json'),
        ('PUSH', HttpResponse),
        ('HALT',),
    ]

def compile_GeoJsonAjax(vm, request):
    vm.instructions = [
        ('PUSH', request.GET.get('lat1', '45')),
        ('PUSH', float),
        ('LOAD', 1),
        ('PUSH', request.GET.get('lng1', '-93.265')),
        ('PUSH', float),
        ('LOAD', 3),
        ('PUSH', BestBikeTrails.objects.filter(the_geom__distance_lte=(Point(vm.stack[3], vm.stack[1], srid=4326), D(mi=2)))),
        ('LOAD', 5),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 13),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 13),
        ('PUSH', ()),
        ('STORE', 7),
        ('LOAD', 7),
        ('PUSH', lambda item: loads(GEOSGeometry(item.the_geom, srid=4326).geojson)),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: loads(GEOSGeometry(item.the_geom, srid=4326).geojson)),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: loads(GEOSGeometry(item.the_geom, srid=4326).geojson)),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: loads(GEOSGeometry(item.the_geom, srid=4326).geojson)),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: loads(GEOSGeometry(item.the_geom, srid=4326).geojson)),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('PUSH', dumps),
        ('PUSH', 'application/json'),
        ('PUSH', HttpResponse),
        ('HALT',),
    ]

def compile_RouterAjax(vm, request):
    vm.instructions = [
        ('PUSH', request.GET.get('bid')),
        ('PUSH', str),
        ('LOAD', 1),
        ('PUSH', request.GET.get('eid')),
        ('PUSH', str),
        ('LOAD', 3),
        ('PUSH', connection.cursor),
        ('LOAD', 5),
        ('LOAD', 5),
        ('PUSH', "select ccp_name, the_geom from pgr_dijkstra('"),
        ('PUSH', "select id, source, target, cost * (4-rtng_ccpx) * (4-rtng_mean) * (4-rtng_cbf7) as cost,cost * (4-rtng_ccpx)*(4-rtng_mean)*(4-rtng_cbf7) * case when one_way=0 then 1 else one_way END as reverse_cost from \"Data_minnesotabiketrails\"'"),
        ('LOAD', 9),
        ('LOAD', 10),
        ('PUSH', ', %s , %s , true,true) join \"Data_minnesotabiketrails\" as bt on bt.id=id2'),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('LOAD', 9),
        ('LOAD', 10),
        ('LOAD', 12),
        ('LOAD', 11),
        ('PUSH', ''),
        ('LOAD', 14),
        ('PUSH', cursor.execute),
        ('PUSH', '%s , %s'),
        ('PUSH', cursor.fetchall),
        ('LOAD', 5),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 59),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 59),
        ('PUSH', ()),
        ('STORE', 7),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda item: item[0]),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('PUSH', dumps),
        ('PUSH', 'application/json'),
        ('PUSH', HttpResponse),
        ('HALT',),
    ]

def compile_NiceRideAjax(vm):
    vm.instructions = [
        ('PUSH', "https://secure.niceridemn.org/data2/bikeStations.xml"),
        ('PUSH', get),
        ('LOAD', 1),
        ('PUSH', ET.fromstring),
        ('LOAD', 3),
        ('PUSH', 'station'),
        ('PUSH', lambda r: r.findall('station')),
        ('LOAD', 5),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 17),
        ('LOAD', 5),
        ('PUSH', 0),
        ('JZ', 17),
        ('PUSH', ()),
        ('STORE', 7),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('LOAD', 7),
        ('PUSH', lambda station: {item.tag: item.text for item in station}),
        ('LOAD', 5),
        ('STORE', 8),
        ('LOAD', 8),
        ('PUSH', []),
        ('STORE', 6),
        ('PUSH', lambda json: [{'type': 'Point', 'coordinates': [d['long'], d['lat']], 'properties': {k: v for k, v in d.items() if k not in ['lat', 'long']}} for d in json if d['public'] == 'true']),
        ('LOAD', 6),
        ('PUSH', dumps),
        ('PUSH', 'application/json'),
        ('PUSH', HttpResponse),
        ('HALT',),
    ]

class MainPage(TemplateView):
    def get(self, request, *args, **kwargs):
        vm = VM()
        compile_MainPage(vm)
        vm.run()
        return vm.POP()

class SearchAjax(TemplateView):
    def get(self, request, *args, **kwargs):
        vm = VM()
        compile_SearchAjax(vm, request)
        vm.run()
        return vm.POP()

class GeoJsonAjax(View):
    def get(self, request, *args, **kwargs):
        vm = VM()
        compile_GeoJsonAjax(vm, request)
        vm.run()
        return vm.POP()

class RouterAjax(View):
    def get(self, request, *args, **kwargs):
        vm = VM()
        compile_RouterAjax(vm, request)
        vm.run()
        return vm.POP()

class NiceRideAjax(View):
    def get(self, request, *args, **kwargs):
        vm = VM()
        compile_NiceRideAjax(vm)
        vm.run()
        return vm.POP()