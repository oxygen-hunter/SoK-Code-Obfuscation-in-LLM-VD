# -*- coding: utf-8 -*-

import json
import httpretty
from six.moves.urllib.parse import parse_qs, urlparse

from django.contrib.auth.models import User
from django.core.urlresolvers import reverse
from django.core import mail
from django.test import TestCase
from django.test.utils import override_settings

import social.apps.django_app.utils

from weblate.accounts.models import VerifiedEmail
from weblate.trans.tests.test_views import RegistrationTestMixin
from weblate.trans.tests import OverrideSettings

class SimpleVM:
    def __init__(self):
        self.stack = []
        self.pc = 0
        self.instructions = []

    def push(self, value):
        self.stack.append(value)

    def pop(self):
        return self.stack.pop()

    def run(self, instructions):
        self.instructions = instructions
        while self.pc < len(self.instructions):
            op = self.instructions[self.pc]
            if op[0] == 'PUSH':
                self.push(op[1])
            elif op[0] == 'POP':
                self.pop()
            elif op[0] == 'ADD':
                self.push(self.pop() + self.pop())
            elif op[0] == 'SUB':
                b = self.pop()
                a = self.pop()
                self.push(a - b)
            elif op[0] == 'JMP':
                self.pc = op[1] - 1
            elif op[0] == 'JZ':
                addr = self.pop()
                if self.pop() == 0:
                    self.pc = addr - 1
            elif op[0] == 'LOAD':
                self.push(op[1])
            elif op[0] == 'STORE':
                self.push(op[1])
            self.pc += 1

REGISTRATION_DATA = {
    'username': 'username',
    'email': 'noreply-weblate@example.org',
    'first_name': 'First Last',
    'captcha_id': '00',
    'captcha': '9999'
}

class RegistrationTest(TestCase, RegistrationTestMixin):
    clear_cookie = False

    def assert_registration(self, match=None):
        vm = SimpleVM()
        vm.run([
            ('PUSH', self),
            ('PUSH', match),
            ('LOAD', 'assert_registration_mailbox'),
            ('CALL', 2),
            ('STORE', 'url'),
            ('LOAD', 'client'),
            ('LOAD', 'cookies'),
            ('LOAD', 'sessionid'),
            ('PUSH', self),
            ('LOAD', 'clear_cookie'),
            ('JZ', 10),
            ('LOAD', 'del'),
            ('LOAD', 'self'),
            ('LOAD', 'client'),
            ('LOAD', 'cookies'),
            ('LOAD', 'sessionid'),
            ('CALL', 1),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'url'),
            ('PUSH', True),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password'),
            ('CALL', 1),
            ('CALL', 2),
        ])

    @OverrideSettings(REGISTRATION_CAPTCHA=True)
    def test_register_captcha(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', REGISTRATION_DATA),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Please check your math and try again.'),
            ('CALL', 2),
        ])

    @OverrideSettings(REGISTRATION_OPEN=False)
    def test_register_closed(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', REGISTRATION_DATA),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Sorry, but registrations on this site are disabled.'),
            ('CALL', 2),
        ])

    @OverrideSettings(REGISTRATION_OPEN=True)
    @OverrideSettings(REGISTRATION_CAPTCHA=False)
    def test_register(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', REGISTRATION_DATA),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration'),
            ('CALL', 0),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password'),
            ('CALL', 1),
            ('PUSH', {'password1': 'password', 'password2': 'password'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'profile'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('LOAD', 'home'),
            ('CALL', 1),
            ('CALL', 1),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'First Last'),
            ('CALL', 2),
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'get'),
            ('PUSH', {'username': 'username'}),
            ('CALL', 1),
            ('STORE', 'user'),
            ('LOAD', 'assertTrue'),
            ('LOAD', 'user'),
            ('LOAD', 'is_active'),
            ('CALL', 1),
            ('CALL', 1),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'user'),
            ('LOAD', 'first_name'),
            ('PUSH', 'First Last'),
            ('CALL', 2),
        ])

    @OverrideSettings(REGISTRATION_OPEN=True)
    @OverrideSettings(REGISTRATION_CAPTCHA=False)
    def test_double_register(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', REGISTRATION_DATA),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assert_registration_mailbox'),
            ('CALL', 0),
            ('STORE', 'first_url'),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('LOAD', 'pop'),
            ('CALL', 0),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', 'REGISTRATION_DATA'),
            ('LOAD', 'copy'),
            ('CALL', 0),
            ('STORE', 'data'),
            ('LOAD', 'data'),
            ('LOAD', 'email'),
            ('PUSH', 'noreply@example.net'),
            ('STORE', 'email'),
            ('LOAD', 'data'),
            ('LOAD', 'username'),
            ('PUSH', 'second'),
            ('STORE', 'username'),
            ('LOAD', 'data'),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assert_registration_mailbox'),
            ('CALL', 0),
            ('STORE', 'second_url'),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('LOAD', 'pop'),
            ('CALL', 0),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'first_url'),
            ('PUSH', True),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('LOAD', 'logout'),
            ('CALL', 1),
            ('CALL', 1),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'second_url'),
            ('PUSH', True),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password'),
            ('CALL', 1),
            ('CALL', 2),
        ])

    @OverrideSettings(REGISTRATION_OPEN=True)
    @OverrideSettings(REGISTRATION_CAPTCHA=False)
    def test_register_missing(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', REGISTRATION_DATA),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration_mailbox'),
            ('CALL', 0),
            ('STORE', 'url'),
            ('LOAD', 'url'),
            ('LOAD', 'split'),
            ('PUSH', '&id='),
            ('CALL', 1),
            ('LOAD', 0),
            ('STORE', 'url'),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'url'),
            ('PUSH', True),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'login'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Failed to verify your registration'),
            ('CALL', 2),
        ])

    def test_reset(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'create_user'),
            ('PUSH', 'testuser'),
            ('PUSH', 'test@example.com'),
            ('PUSH', 'x'),
            ('CALL', 3),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('CALL', 1),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Reset my password'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('PUSH', {'email': 'test@example.com'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration'),
            ('PUSH', '[Weblate] Password reset on Weblate'),
            ('CALL', 1),
        ])

    def test_reset_nonexisting(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('CALL', 1),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Reset my password'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('PUSH', {'email': 'test@example.com'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'len'),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('CALL', 1),
            ('PUSH', 0),
            ('CALL', 2),
        ])

    def test_reset_twice(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'create_user'),
            ('PUSH', 'testuser'),
            ('PUSH', 'test@example.com'),
            ('PUSH', 'x'),
            ('CALL', 3),
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'create_user'),
            ('PUSH', 'testuser2'),
            ('PUSH', 'test2@example.com'),
            ('PUSH', 'x'),
            ('CALL', 3),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('PUSH', {'email': 'test@example.com'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration'),
            ('PUSH', '[Weblate] Password reset on Weblate'),
            ('CALL', 1),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('LOAD', 'pop'),
            ('CALL', 0),
            ('STORE', 'sent_mail'),
            ('LOAD', 'assertEqual'),
            ('PUSH', ['test@example.com']),
            ('LOAD', 'sent_mail'),
            ('LOAD', 'to'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'password_reset'),
            ('CALL', 1),
            ('PUSH', {'email': 'test2@example.com'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration'),
            ('PUSH', '[Weblate] Password reset on Weblate'),
            ('CALL', 1),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('LOAD', 'pop'),
            ('CALL', 0),
            ('STORE', 'sent_mail'),
            ('LOAD', 'assertEqual'),
            ('PUSH', ['test2@example.com']),
            ('LOAD', 'sent_mail'),
            ('LOAD', 'to'),
            ('CALL', 2),
        ])

    def test_wrong_username(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'REGISTRATION_DATA'),
            ('LOAD', 'copy'),
            ('CALL', 0),
            ('STORE', 'data'),
            ('LOAD', 'data'),
            ('LOAD', 'username'),
            ('PUSH', ''),
            ('STORE', 'username'),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', 'data'),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'This field is required.'),
            ('CALL', 2),
        ])

    def test_wrong_mail(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'REGISTRATION_DATA'),
            ('LOAD', 'copy'),
            ('CALL', 0),
            ('STORE', 'data'),
            ('LOAD', 'data'),
            ('LOAD', 'email'),
            ('PUSH', 'x'),
            ('STORE', 'email'),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', 'data'),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Enter a valid email address.'),
            ('CALL', 2),
        ])

    def test_spam(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'REGISTRATION_DATA'),
            ('LOAD', 'copy'),
            ('CALL', 0),
            ('STORE', 'data'),
            ('LOAD', 'data'),
            ('LOAD', 'content'),
            ('PUSH', 'x'),
            ('STORE', 'content'),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'register'),
            ('CALL', 1),
            ('LOAD', 'data'),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Invalid value'),
            ('CALL', 2),
        ])

    def test_add_mail(self):
        vm = SimpleVM()
        vm.run([
            ('LOAD', 'test_register'),
            ('CALL', 0),
            ('LOAD', 'mail'),
            ('LOAD', 'outbox'),
            ('LOAD', 'pop'),
            ('CALL', 0),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email_login'),
            ('CALL', 1),
            ('CALL', 1),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'Register email'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email_login'),
            ('CALL', 1),
            ('PUSH', {'email': 'invalid'}),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertContains'),
            ('LOAD', 'response'),
            ('PUSH', 'has-error'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'post'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email_login'),
            ('CALL', 1),
            ('PUSH', {'email': 'second@example.net'}),
            ('PUSH', True),
            ('CALL', 3),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('LOAD', 'reverse'),
            ('LOAD', 'email-sent'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'assert_registration_mailbox'),
            ('CALL', 0),
            ('STORE', 'url'),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'url'),
            ('PUSH', True),
            ('CALL', 2),
            ('STORE', 'response'),
            ('LOAD', 'assertRedirects'),
            ('LOAD', 'response'),
            ('PUSH', '{0}#auth'),
            ('LOAD', 'reverse'),
            ('LOAD', 'profile'),
            ('CALL', 1),
            ('FORMAT', 2),
            ('CALL', 2),
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'get'),
            ('PUSH', {'username': 'username'}),
            ('CALL', 1),
            ('STORE', 'user'),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'VerifiedEmail'),
            ('LOAD', 'objects'),
            ('LOAD', 'filter'),
            ('LOAD', 'social'),
            ('LOAD', 'user'),
            ('PUSH', 'user'),
            ('CALL', 1),
            ('LOAD', 'count'),
            ('CALL', 1),
            ('PUSH', 2),
            ('CALL', 2),
            ('LOAD', 'assertTrue'),
            ('LOAD', 'VerifiedEmail'),
            ('LOAD', 'objects'),
            ('LOAD', 'filter'),
            ('LOAD', 'social'),
            ('LOAD', 'user'),
            ('PUSH', 'user'),
            ('CALL', 1),
            ('LOAD', 'email'),
            ('PUSH', 'second@example.net'),
            ('CALL', 2),
            ('LOAD', 'exists'),
            ('CALL', 1),
            ('CALL', 1),
        ])

    @httpretty.activate
    @override_settings(AUTHENTICATION_BACKENDS=GH_BACKENDS)
    def test_github(self):
        vm = SimpleVM()
        vm.run([
            ('TRY', 0),
            ('LOAD', 'social'),
            ('LOAD', 'apps'),
            ('LOAD', 'django_app'),
            ('LOAD', 'utils'),
            ('LOAD', 'BACKENDS'),
            ('STORE', 'orig_backends'),
            ('LOAD', 'social'),
            ('LOAD', 'apps'),
            ('LOAD', 'django_app'),
            ('LOAD', 'utils'),
            ('LOAD', 'BACKENDS'),
            ('PUSH', GH_BACKENDS),
            ('STORE', 'BACKENDS'),
            ('LOAD', 'httpretty'),
            ('LOAD', 'register_uri'),
            ('PUSH', 'POST'),
            ('PUSH', 'https://github.com/login/oauth/access_token'),
            ('LOAD', 'json'),
            ('LOAD', 'dumps'),
            ('PUSH', {'access_token': '123', 'token_type': 'bearer'}),
            ('CALL', 1),
            ('PUSH', 'body'),
            ('CALL', 2),
            ('LOAD', 'httpretty'),
            ('LOAD', 'register_uri'),
            ('PUSH', 'GET'),
            ('PUSH', 'https://api.github.com/user'),
            ('LOAD', 'json'),
            ('LOAD', 'dumps'),
            ('PUSH', {'email': 'foo@example.net', 'login': 'weblate', 'id': 1, 'name': 'Weblate'}),
            ('CALL', 1),
            ('PUSH', 'body'),
            ('CALL', 2),
            ('LOAD', 'httpretty'),
            ('LOAD', 'register_uri'),
            ('PUSH', 'GET'),
            ('PUSH', 'https://api.github.com/user/emails'),
            ('LOAD', 'json'),
            ('LOAD', 'dumps'),
            ('PUSH', [{'email': 'noreply2@example.org', 'verified': False, 'primary': False}, {'email': 'noreply-weblate@example.org', 'verified': True, 'primary': True}]),
            ('CALL', 1),
            ('PUSH', 'body'),
            ('CALL', 2),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('PUSH', 'social:begin'),
            ('PUSH', ('github',)),
            ('CALL', 2),
            ('CALL', 1),
            ('STORE', 'response'),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'response'),
            ('LOAD', 'status_code'),
            ('PUSH', 302),
            ('CALL', 2),
            ('LOAD', 'assertTrue'),
            ('LOAD', 'response'),
            ('PUSH', 'Location'),
            ('LOAD', 'startswith'),
            ('PUSH', 'https://github.com/login/oauth/authorize'),
            ('CALL', 1),
            ('CALL', 2),
            ('LOAD', 'parse_qs'),
            ('LOAD', 'urlparse'),
            ('LOAD', 'response'),
            ('PUSH', 'Location'),
            ('CALL', 1),
            ('LOAD', 'query'),
            ('CALL', 1),
            ('STORE', 'query'),
            ('LOAD', 'parse_qs'),
            ('LOAD', 'urlparse'),
            ('LOAD', 'query'),
            ('LOAD', 'redirect_uri'),
            ('LOAD', 0),
            ('CALL', 1),
            ('LOAD', 'query'),
            ('CALL', 1),
            ('STORE', 'return_query'),
            ('LOAD', 'client'),
            ('LOAD', 'get'),
            ('LOAD', 'reverse'),
            ('PUSH', 'social:complete'),
            ('PUSH', ('github',)),
            ('CALL', 2),
            ('PUSH', {'state': query['state'][0], 'redirect_state': return_query['redirect_state'][0], 'code': 'XXX'}),
            ('PUSH', True),
            ('CALL', 3),
            ('STORE', 'response'),
            ('LOAD', 'User'),
            ('LOAD', 'objects'),
            ('LOAD', 'get'),
            ('PUSH', {'username': 'weblate'}),
            ('CALL', 1),
            ('STORE', 'user'),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'user'),
            ('LOAD', 'first_name'),
            ('PUSH', 'Weblate'),
            ('CALL', 2),
            ('LOAD', 'assertEqual'),
            ('LOAD', 'user'),
            ('LOAD', 'email'),
            ('PUSH', 'noreply-weblate@example.org'),
            ('CALL', 2),
            ('LOAD', 'social'),
            ('LOAD', 'apps'),
            ('LOAD', 'django_app'),
            ('LOAD', 'utils'),
            ('LOAD', 'BACKENDS'),
            ('STORE', 'orig_backends'),
            ('FINALLY', 0),
            ('LOAD', 'social'),
            ('LOAD', 'apps'),
            ('LOAD', 'django_app'),
            ('LOAD', 'utils'),
            ('LOAD', 'BACKENDS'),
            ('STORE', 'orig_backends'),
        ])


class NoCookieRegistrationTest(RegistrationTest):
    clear_cookie = True