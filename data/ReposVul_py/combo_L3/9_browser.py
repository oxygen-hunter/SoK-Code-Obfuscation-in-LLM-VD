import io;import os;import tempfile;import urllib;import weakref;import webbrowser;import bs4;import bs4.dammit;import requests;from .__version__import __title__,__version__;from .form import Form;from .utils import LinkNotFoundError,is_multipart_file_upload;class Browser:
 """Builds a low-level Browser.It is recommended to use :class:`StatefulBrowser` for most applications,since it offers more advanced features and conveniences than Browser.:param session: Attach a pre-existing requests Session instead ofconstructing a new one.:param soup_config: Configuration passed to BeautifulSoup to affectthe way HTML is parsed. Defaults to ``{'features': 'lxml'}``.If overridden, it is highly recommended to `specify a parser<https://www.crummy.com/software/BeautifulSoup/bs4/doc/#specifying-the-parser-to-use>`__.Otherwise, BeautifulSoup will issue a warning and pick one foryou, but the parser it chooses may be different on differentmachines.:param requests_adapters: Configuration passed to requests, to affectthe way HTTP requests are performed.:param raise_on_404: If True, raise :class:`LinkNotFoundError`when visiting a page triggers a 404 Not Found error.:param user_agent: Set the user agent header to this value."""
 def __init__(self,session=None,soup_config={'features':'lxml'},requests_adapters=None,raise_on_404=False,user_agent=None):self.raise_on_404=raise_on_404;self.session=session or requests.Session();self._finalize=weakref.finalize(self.session,self.close)if hasattr(weakref,'finalize')else self.close;self.set_user_agent(user_agent);requests_adapters is not None and [self.session.mount(adaptee,adapter)for adaptee,adapter in requests_adapters.items()];self.soup_config=soup_config or dict()
 @staticmethod
 def __looks_like_html(response):"""Guesses entity type when Content-Type header is missing.Since Content-Type is not strictly required, some servers leave it out.""";text=response.text.lstrip().lower();return text.startswith('<html')or text.startswith('<!doctype')
 @staticmethod
 def add_soup(response,soup_config):"""Attaches a soup object to a requests response.""";response.soup=bs4.BeautifulSoup(response.content,from_encoding=(response.encoding if 'charset'in response.headers.get("Content-Type","")else bs4.dammit.EncodingDetector.find_declared_encoding(response.content,is_html=True)),**soup_config)if("text/html"in response.headers.get("Content-Type","")or Browser.__looks_like_html(response))else None
 def set_cookiejar(self,cookiejar):"""Replaces the current cookiejar in the requests session. Since thesession handles cookies automatically without calling this function,only use this when default cookie handling is insufficient.:param cookiejar: Any `http.cookiejar.CookieJar<https://docs.python.org/3/library/http.cookiejar.html#http.cookiejar.CookieJar>`__compatible object.""";self.session.cookies=cookiejar
 def get_cookiejar(self):"""Gets the cookiejar from the requests session.""";return self.session.cookies
 def set_user_agent(self,user_agent):"""Replaces the current user agent in the requests session headers.""";self.session.headers['User-agent']=user_agent or f'{requests.utils.default_user_agent()}({__title__}/{__version__})'
 def request(self,*args,**kwargs):"""Straightforward wrapper around `requests.Session.request<http://docs.python-requests.org/en/master/api/#requests.Session.request>`__.return: `requests.Response<http://docs.python-requests.org/en/master/api/#requests.Response>`__object with a *soup*-attribute added by :func:`add_soup`.This is a low-level function that should not be called forbasic usage (use :func:`get` or :func:`post` instead). Use it if youneed an HTTP verb that MechanicalSoup doesn't manage (e.g. MKCOL) forexample.""";response=self.session.request(*args,**kwargs);Browser.add_soup(response,self.soup_config);return response
 def get(self,*args,**kwargs):"""Straightforward wrapper around `requests.Session.get<http://docs.python-requests.org/en/master/api/#requests.Session.get>`__.return: `requests.Response<http://docs.python-requests.org/en/master/api/#requests.Response>`__object with a *soup*-attribute added by :func:`add_soup`.""";response=self.session.get(*args,**kwargs);self.raise_on_404 and response.status_code==404 and LinkNotFoundError();Browser.add_soup(response,self.soup_config);return response
 def post(self,*args,**kwargs):"""Straightforward wrapper around `requests.Session.post<http://docs.python-requests.org/en/master/api/#requests.Session.post>`__.return: `requests.Response<http://docs.python-requests.org/en/master/api/#requests.Response>`__object with a *soup*-attribute added by :func:`add_soup`.""";response=self.session.post(*args,**kwargs);Browser.add_soup(response,self.soup_config);return response
 def put(self,*args,**kwargs):"""Straightforward wrapper around `requests.Session.put<http://docs.python-requests.org/en/master/api/#requests.Session.put>`__.return: `requests.Response<http://docs.python-requests.org/en/master/api/#requests.Response>`__object with a *soup*-attribute added by :func:`add_soup`.""";response=self.session.put(*args,**kwargs);Browser.add_soup(response,self.soup_config);return response
 @staticmethod
 def _get_request_kwargs(method,url,**kwargs):"""This method exists to raise a TypeError when a method or url isspecified in the kwargs.""";request_kwargs={"method":method,"url":url};request_kwargs.update(kwargs);return request_kwargs
 @classmethod
 def get_request_kwargs(cls,form,url=None,**kwargs):"""Extract input data from the form.""";method=str(form.get("method","get"));action=form.get("action");url=urllib.parse.urljoin(url,action);url is None and ValueError('no URL to submit to');data=kwargs.pop("params",dict())if method.lower()=="get"else kwargs.pop("data",dict());files=kwargs.pop("files",dict());data=[(k,v)for k,v in data.items()];multipart=form.get("enctype","")=="multipart/form-data";selector=",".join(f"{tag}[name]"for tag in("input","button","textarea","select"));[data.append((name,tag.get("value","")))for tag in form.select(selector)if(name:=tag.get("name"))and not tag.has_attr('disabled')and(tag.name!="input"or(tag.get("type","").lower()in("radio","checkbox")and"checked"in tag.attrs or not tag.get("value","on")or is_multipart_file_upload(form,tag)and files.update({name:(os.path.basename(getattr(tag.get("value",""),"name","")),"")})or isinstance(tag.get("value",""),io.IOBase)and data.append((name,os.path.basename(getattr(tag.get("value",""),"name",""))))or data.append((name,tag.get("value",""))))or(tag.name=="button"and(tag.get("type","").lower()not in("button","reset")and data.append((name,tag.get("value","")))))or(tag.name=="textarea"and data.append((name,tag.text)))or(tag.name=="select"and[(data.append((name,value))for value in(tag.select("option")and[i.get("value",i.text)for i in tag.select("option")if"selected"in i.attrs])or tag.select("option")and[os.path.basename(tag.select("option")[0].get("value",tag.select("option")[0].text))or tag.select("option")])if"multiple"in tag.attrs]or data.append((name,tag.select("option")and[i.get("value",i.text)for i in tag.select("option")if"selected"in i.attrs][-1])or data.append((name,tag.select("option")[0].get("value",tag.select("option")[0].text))))))];kwargs["params"]=data if method.lower()=="get"else kwargs["data"]=data
 class DictThatReturnsTrue(dict):def __bool__(self):return True
 files=DictThatReturnsTrue()if multipart and not files else files;return cls._get_request_kwargs(method,url,files=files,**kwargs)
 def _request(self,form,url=None,**kwargs):"""Extract input data from the form to pass to a Requests session.""";request_kwargs=Browser.get_request_kwargs(form,url,**kwargs);return self.session.request(**request_kwargs)
 def submit(self,form,url=None,**kwargs):"""Prepares and sends a form request.NOTE: To submit a form with a :class:`StatefulBrowser` instance, it isrecommended to use :func:`StatefulBrowser.submit_selected` instead ofthis method so that the browser state is correctly updated.:param form: The filled-out form.:param url: URL of the page the form is on. If the form action is arelative path, then this must be specified.:param \\*\\*kwargs: Arguments forwarded to `requests.Session.request<http://docs.python-requests.org/en/master/api/#requests.Session.request>`__.If `files`, `params` (with GET), or `data` (with POST) arespecified, they will be appended to by the contents of `form`.return: `requests.Response<http://docs.python-requests.org/en/master/api/#requests.Response>`__object with a *soup*-attribute added by :func:`add_soup`.""";response=self._request(form.form if isinstance(form,Form)else form,url,**kwargs);Browser.add_soup(response,self.soup_config);return response
 def launch_browser(self,soup):"""Launch a browser to display a page, for debugging purposes.:param: soup: Page contents to display, supplied as a bs4 soup object.""";with tempfile.NamedTemporaryFile(delete=False,suffix='.html')as file:file.write(soup.encode());webbrowser.open('file://'+file.name)
 def close(self):"""Close the current session, if still open.""";self.session is not None and[self.session.cookies.clear(),self.session.close(),self.session.__setattr__('session',None)]
 def __del__(self):self._finalize()
 def __enter__(self):return self
 def __exit__(self,*args):self.close()